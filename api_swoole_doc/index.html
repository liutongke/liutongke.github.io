<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>api-swooleæ¡†æ¶æ–‡æ¡£ | kekeçš„ä¸ªäººåšå®¢</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="api-swooleæ¡†æ¶æ–‡æ¡£">



  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your-google-analytics-id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">

  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">â†</span>é¦–é¡µ</a>
	
	<a href="/posts">å½’æ¡£</a>
	<a href="/tags">æ ‡ç­¾</a>
	<a href="/about">å…³äº</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">api-swooleæ¡†æ¶æ–‡æ¡£</h1>

    <div class="tip">
        <time datetime="2022-09-10 00:00:00 &#43;0000 UTC">2022å¹´09æœˆ10æ—¥</time>
        <span class="split">
          Â·
        </span>
        <span>
          6754å­—
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          14åˆ†é’Ÿ
        </span>
        <span class="split">
          Â·
        </span>
        <span>
          <span id="busuanzi_container_page_pv">é˜…è¯»é‡<span id="busuanzi_value_page_pv"></span>æ¬¡</span>
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#11ä¸‹è½½ä¸å®‰è£…"><strong>1.1ä¸‹è½½ä¸å®‰è£…</strong></a></li>
        <li><a href="#12é€šè¿‡-composer-åˆ›å»ºé¡¹ç›®"><strong>1.2é€šè¿‡ Composer åˆ›å»ºé¡¹ç›®</strong></a></li>
        <li><a href="#13å¯åŠ¨"><strong>1.3å¯åŠ¨</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#21ç¼–å†™ä¸€ä¸ªæ¥å£"><strong>2.1ç¼–å†™ä¸€ä¸ªæ¥å£</strong></a></li>
        <li><a href="#22å®šä¹‰è·¯ç”±"><strong>2.2å®šä¹‰è·¯ç”±</strong></a></li>
        <li><a href="#23å¯åŠ¨é¡¹ç›®"><strong>2.3å¯åŠ¨é¡¹ç›®</strong></a></li>
        <li><a href="#24è®¿é—®æ¥å£"><strong>2.4è®¿é—®æ¥å£</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#41é…ç½®æ–‡ä»¶"><strong>4.1é…ç½®æ–‡ä»¶</strong></a></li>
        <li><a href="#42å‚æ•°è¯´æ˜"><strong>4.2å‚æ•°è¯´æ˜</strong></a></li>
        <li><a href="#43é…ç½®è¯»å–ç¤ºä¾‹"><strong>4.3é…ç½®è¯»å–ç¤ºä¾‹</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#61httpwebsocketæœåŠ¡å™¨é…ç½®"><strong>6.1HTTP/websocketæœåŠ¡å™¨é…ç½®</strong></a></li>
        <li><a href="#62httpè·¯ç”±"><strong>6.2HTTPè·¯ç”±</strong></a></li>
        <li><a href="#63httpæ§åˆ¶å™¨"><strong>6.3HTTPæ§åˆ¶å™¨</strong></a></li>
        <li><a href="#64æ¥å£å‚æ•°è§„åˆ™"><strong>6.4æ¥å£å‚æ•°è§„åˆ™</strong></a></li>
        <li><a href="#65websocketè·¯ç”±"><strong>6.5websocketè·¯ç”±</strong></a></li>
        <li><a href="#66websocketæ§åˆ¶å™¨"><strong>6.6websocketæ§åˆ¶å™¨</strong></a></li>
        <li><a href="#67websocketæ¥å£å‚æ•°è§„åˆ™"><strong>6.7websocketæ¥å£å‚æ•°è§„åˆ™</strong></a></li>
        <li><a href="#68httpwebsocketå‹¾å­å‡½æ•°"><strong>6.8http/websocketå‹¾å­å‡½æ•°</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#71tcpæœåŠ¡å™¨é…ç½®"><strong>7.1TCPæœåŠ¡å™¨é…ç½®</strong></a></li>
        <li><a href="#71udpæœåŠ¡å™¨é…ç½®"><strong>7.1UDPæœåŠ¡å™¨é…ç½®</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#81redis"><strong>8.1Redis</strong></a></li>
        <li><a href="#82mysql"><strong>8.2MySQL</strong></a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h1 id="ä¸€å¼€å§‹"><strong>(ä¸€).å¼€å§‹</strong> <a href="#%e4%b8%80%e5%bc%80%e5%a7%8b" class="anchor">ğŸ”—</a></h1><h3 id="11ä¸‹è½½ä¸å®‰è£…"><strong>1.1ä¸‹è½½ä¸å®‰è£…</strong> <a href="#11%e4%b8%8b%e8%bd%bd%e4%b8%8e%e5%ae%89%e8%a3%85" class="anchor">ğŸ”—</a></h3><p><strong>æºç åœ°å€ï¼š</strong>
<a href="https://github.com/liutongke/api-swoole" target="_blank" rel="noopener">api-swooleæ¡†æ¶githubæºç åœ°å€</a>
<a href="https://gitee.com/tongke/api-swoole" target="_blank" rel="noopener">api-swooleæ¡†æ¶giteeæºç åœ°å€</a></p>
<p>éœ€è¦ç¡®ä¿è¿è¡Œç¯å¢ƒè¾¾åˆ°äº†ä»¥ä¸‹çš„è¦æ±‚ï¼š</p>
<ul>
<li>PHP &gt;= 7.4</li>
<li>Swoole PHP æ‰©å±• &gt;= 4.5</li>
<li>Redis PHP æ‰©å±• ï¼ˆå¦‚éœ€ä½¿ç”¨ Redis å®¢æˆ·ç«¯ï¼‰</li>
<li>PDO PHP æ‰©å±• ï¼ˆå¦‚éœ€ä½¿ç”¨ MySQL å®¢æˆ·ç«¯ï¼‰</li>
</ul>
<h3 id="12é€šè¿‡-composer-åˆ›å»ºé¡¹ç›®"><strong>1.2é€šè¿‡ Composer åˆ›å»ºé¡¹ç›®</strong> <a href="#12%e9%80%9a%e8%bf%87-composer-%e5%88%9b%e5%bb%ba%e9%a1%b9%e7%9b%ae" class="anchor">ğŸ”—</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>composer create-project api-swoole/skeleton
</span></span></code></pre></div><h3 id="13å¯åŠ¨"><strong>1.3å¯åŠ¨</strong> <a href="#13%e5%90%af%e5%8a%a8" class="anchor">ğŸ”—</a></h3><p>æ”¯æŒ HTTP æœåŠ¡ã€WebSocket æœåŠ¡ã€tcpæœåŠ¡,é¡¹ç›®æ ¹ç›®å½•<code>./apiswoole.php</code>æ‰§è¡Œå‘½ä»¤ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>php apiswoole.php
</span></span></code></pre></div><h1 id="äºŒhello-world"><strong>(äºŒ).Hello World</strong> <a href="#%e4%ba%8chello-world" class="anchor">ğŸ”—</a></h1><h3 id="21ç¼–å†™ä¸€ä¸ªæ¥å£"><strong>2.1ç¼–å†™ä¸€ä¸ªæ¥å£</strong> <a href="#21%e7%bc%96%e5%86%99%e4%b8%80%e4%b8%aa%e6%8e%a5%e5%8f%a3" class="anchor">ğŸ”—</a></h3><p>åœ¨api-swooleæ¡†æ¶ä¸­ï¼Œä¸šåŠ¡ä¸»è¦ä»£ç åœ¨appç›®å½•ä¸­ã€‚é‡Œé¢å„ä¸ªå‘½åç©ºé—´å¯¹åº”ä¸€ä¸ªå­ç›®å½•ï¼Œé¡¹ç›®çš„é»˜è®¤å‘½åç©ºé—´æ˜¯Appï¼Œåˆ›å»ºé¡¹ç›®åappç›®å½•ä¸­åŒ…å«Commonã€Controllerã€Extä¸‰ä¸ªå­ç›®å½•ï¼ŒCommonç›®å½•å­˜æ”¾å‡½æ•°çš„functions.phpæ–‡ä»¶ï¼ŒExtä¸€èˆ¬æ”¾ç½®å·¥å…·ç­‰ã€‚ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>â””â”€â”€ app
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ Controller # æ”¾ç½®æ¥å£æºä»£ç ï¼Œç›¸å½“äºæ§åˆ¶å™¨å±‚
</span></span><span style="display:flex;"><span>    â”œâ”€â”€ Common # å…¬å…±ä»£ç ç›®å½•ï¼Œ
</span></span><span style="display:flex;"><span>    â””â”€â”€ Ext# æ”¾ç½®å·¥å…·ç­‰
</span></span></code></pre></div><p>å½“é¡¹ç›®éœ€è¦æ–°å¢æ¥å£æ—¶ï¼Œå…ˆåœ¨<code>./app/Controller</code>ç›®å½•ä¸­æ–°å»º<code>hello.php</code>æ–‡ä»¶ï¼Œå¹¶ç”¨ç¼–è¾‘å™¨ç¼–è¾‘ä»£ç ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Hello extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;code&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; &#39;hello world&#39;
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="22å®šä¹‰è·¯ç”±"><strong>2.2å®šä¹‰è·¯ç”±</strong> <a href="#22%e5%ae%9a%e4%b9%89%e8%b7%af%e7%94%b1" class="anchor">ğŸ”—</a></h3><p>åœ¨<code>route/http.php</code>è·¯ç”±æ–‡ä»¶ä¸­å®šä¹‰é¡¹ç›®è·¯ç”±ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®šä¹‰çš„æµè§ˆå™¨è®¿é—®åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>@</code>å‰åŠéƒ¨åˆ†ä¸ºæ–‡ä»¶çš„å®Œæ•´å‘½åç©ºé—´ï¼Œ<code>@</code>ååŠéƒ¨åˆ†ä¸ºåœ¨ç±»ä¸­è°ƒç”¨çš„å…·ä½“æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/hello&#34;, &#34;App\Controller\Hello@index&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="23å¯åŠ¨é¡¹ç›®"><strong>2.3å¯åŠ¨é¡¹ç›®</strong> <a href="#23%e5%90%af%e5%8a%a8%e9%a1%b9%e7%9b%ae" class="anchor">ğŸ”—</a></h3><p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä»¥éå®ˆæŠ¤æ¨¡å¼å¯åŠ¨ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>php apiswoole.php
</span></span></code></pre></div><p>é»˜è®¤æƒ…å†µä¸‹ç›‘å¬æœ¬åœ°çš„HTTPå’Œwebsocketçš„9501ç«¯å£ï¼Œåœ¨cmdä¸­å‡ºç°å¦‚ä¸‹è¾“å‡ºä¿¡æ¯è¡¨ç¤ºé¡¹ç›®å¯åŠ¨æˆåŠŸã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[Success] Swoole: 4.5.9, PHP: 7.4.13, Port: 9501
</span></span><span style="display:flex;"><span>[Success] Swoole Http Server runningï¼šhttp://0.0.0.0:9501
</span></span><span style="display:flex;"><span>[Success] Swoole websocket Server runningï¼šws://0.0.0.0:9501
</span></span><span style="display:flex;"><span>[Success] Swoole tcp Server runningï¼š0.0.0.0:9500
</span></span><span style="display:flex;"><span>[Success] Swoole udp Server runningï¼š0.0.0.0:9502
</span></span></code></pre></div><h3 id="24è®¿é—®æ¥å£"><strong>2.4è®¿é—®æ¥å£</strong> <a href="#24%e8%ae%bf%e9%97%ae%e6%8e%a5%e5%8f%a3" class="anchor">ğŸ”—</a></h3><p>åœ¨æµè§ˆå™¨åœ°å€æ ä¸­è¾“å…¥å®šä¹‰çš„è·¯ç”±åœ°å€ï¼Œåœ°å€ç»„æˆ<code>http://ipç½‘å€:ç«¯å£/å®šä¹‰çš„è·¯ç”±</code>ã€‚</p>
<p><code>http://127.0.0.1:9501/hello</code></p>
<p>è¯·æ±‚æˆåŠŸè¿”å›æ•°æ®é»˜è®¤jsonæ–¹å¼è¿”å›ï¼ŒåŒ…å«é»˜è®¤çš„codeã€msgã€dataå­—æ®µï¼Œdataä¸­æ•°æ®ä¸ºæ–¹æ³•ä¸­è¿”å›çš„æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>: <span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;msg&#34;</span>: <span style="color:#b44">&#34;success&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>: <span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: <span style="color:#b44">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="ä¸‰åå‘ä»£ç†nginx--swoole-é…ç½®"><strong>(ä¸‰).åå‘ä»£ç†ï¼ˆNginx + Swoole é…ç½®ï¼‰</strong> <a href="#%e4%b8%89%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86nginx--swoole-%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h1><p>ç”±äº <code>Http\Server</code> å¯¹ <code>HTTP</code> åè®®çš„æ”¯æŒå¹¶ä¸å®Œæ•´ï¼Œå»ºè®®ä»…ä½œä¸ºåº”ç”¨æœåŠ¡å™¨ï¼Œç”¨äºå¤„ç†åŠ¨æ€è¯·æ±‚ï¼Œå¹¶ä¸”åœ¨å‰ç«¯å¢åŠ  <code>Nginx</code> ä½œä¸ºä»£ç†ã€‚ï¼ˆ<a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">å‚è€ƒåœ°å€</a>ï¼‰</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name swoole.test;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_set_header Host $http_host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        proxy_pass http://127.0.0.1:9501;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å¯ä»¥é€šè¿‡è¯»å– <code>$request-&gt;header['x-real-ip']</code> æ¥è·å–å®¢æˆ·ç«¯çš„çœŸå® <code>IP</code></p>
<h1 id="å››é…ç½®"><strong>(å››).é…ç½®</strong> <a href="#%e5%9b%9b%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h1><h3 id="41é…ç½®æ–‡ä»¶"><strong>4.1é…ç½®æ–‡ä»¶</strong> <a href="#41%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="anchor">ğŸ”—</a></h3><p>é»˜è®¤configæ–‡ä»¶å¤¹ä¸‹åŒ…å«conf.phpã€db.phpã€events.phpä¸‰ä¸ªæ–‡ä»¶ï¼Œconf.phpæ”¾ç½®é¡¹ç›®çš„é…ç½®ä¿¡æ¯ï¼Œhttpã€tcpã€udpã€websocketç­‰é…ç½®ã€‚db.phpè´Ÿè´£é…ç½®MySQLã€Redisè¿æ¥ï¼Œevents.phpè´Ÿè´£å®šä¹‰å®šåˆ¶ç‰¹å®šäº‹ä»¶æ³¨å†Œç›‘å¬ï¼Œç°æ”¯æŒ<code>workerStartã€openã€closeã€taskã€finish</code>äº‹ä»¶æ³¨å†Œ ã€‚å¯ä»¥é€šè¿‡<code>DI()-&gt;config-&gt;get('conf.ws')</code>æˆ–è€…<code>\Sapi\Di::one()-&gt;config-&gt;get('conf.ws')</code>æ–¹å¼è¯»å–é…ç½®ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./config/
</span></span><span style="display:flex;"><span>â”œâ”€â”€ conf.php #httpã€tcpã€udpã€websocketç­‰é…ç½®
</span></span><span style="display:flex;"><span>â”œâ”€â”€ db.php #æ•°æ®åº“é…ç½®
</span></span><span style="display:flex;"><span>â””â”€â”€ events.php #å®šåˆ¶ç‰¹å®šäº‹ä»¶æ³¨å†Œç›‘å¬
</span></span></code></pre></div><h3 id="42å‚æ•°è¯´æ˜"><strong>4.2å‚æ•°è¯´æ˜</strong> <a href="#42%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e" class="anchor">ğŸ”—</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;debug&#39; =&gt; true,//true è°ƒè¯•æ¨¡å¼ false å…³é—­è°ƒè¯•
</span></span><span style="display:flex;"><span>    &#39;log&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;displayConsole&#39; =&gt; true,//æ§åˆ¶å°æ‰“å°æ—¥å¿—ï¼Œtrueæ‰“å¼€ false å…³é—­
</span></span><span style="display:flex;"><span>        &#39;saveLog&#39; =&gt; true,//ä¿å­˜æ—¥å¿— true æ‰“å¼€ false å…³é—­
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;udp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//æŒ‡å®šç›‘å¬çš„ipåœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9502,//æŒ‡å®šç›‘å¬ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_UDP,//æŒ‡å®šè¿™ç»„ Server çš„ç±»å‹
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;packet&#39;, \App\Controller\UdpServe::class, &#39;onPacket&#39;],//å›è°ƒäº‹ä»¶
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],//é…ç½®é€‰é¡¹https://wiki.swoole.com/#/server/setting
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//æŒ‡å®šç›‘å¬çš„ipåœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9501,//æŒ‡å®šç›‘å¬ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,//æŒ‡å®šè¿™ç»„ Server çš„ç±»å‹
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],//å›è°ƒäº‹ä»¶
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],//é…ç½®é€‰é¡¹https://wiki.swoole.com/#/server/setting
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;ws&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//æŒ‡å®šç›‘å¬çš„ipåœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,//æŒ‡å®šç›‘å¬ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,//æŒ‡å®šè¿™ç»„ Server çš„ç±»å‹
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;open&#39;, \Sapi\Events::class, &#39;onOpen&#39;],
</span></span><span style="display:flex;"><span>            [&#39;message&#39;, \Sapi\Events::class, &#39;onMessage&#39;],
</span></span><span style="display:flex;"><span>            [&#39;close&#39;, \Sapi\Events::class, &#39;onClose&#39;],
</span></span><span style="display:flex;"><span>            [&#39;request&#39;, \Sapi\Events::class, &#39;onRequest&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Task&#39;, \Sapi\Events::class, &#39;onTask&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Finish&#39;, \Sapi\Events::class, &#39;onFinish&#39;],
</span></span><span style="display:flex;"><span>            [&#39;workerStart&#39;, \Sapi\Events::class, &#39;onWorkerStart&#39;],
</span></span><span style="display:flex;"><span>            [&#39;start&#39;, \Sapi\Events::class, &#39;onStart&#39;],
</span></span><span style="display:flex;"><span>        ],//å›è°ƒäº‹ä»¶
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [
</span></span><span style="display:flex;"><span>            &#39;daemonize&#39; =&gt; false,//è®¾ç½® daemonize =&gt; true æ—¶ï¼Œç¨‹åºå°†è½¬å…¥åå°ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œã€‚é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨ç«¯ç¨‹åºå¿…é¡»å¯ç”¨æ­¤é¡¹ã€‚å¦‚æœä¸å¯ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå½“ ssh ç»ˆç«¯é€€å‡ºåï¼Œç¨‹åºå°†è¢«ç»ˆæ­¢è¿è¡Œ
</span></span><span style="display:flex;"><span>            &#39;worker_num&#39; =&gt; swoole_cpu_num(),
</span></span><span style="display:flex;"><span>            &#39;log_file&#39; =&gt; &#39;storage/swoole&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_rotation&#39; =&gt; SWOOLE_LOG_ROTATION_DAILY,
</span></span><span style="display:flex;"><span>            &#39;log_date_format&#39; =&gt; &#39;%Y-%m-%d %H:%M:%S&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_level&#39; =&gt; SWOOLE_LOG_DEBUG,
</span></span><span style="display:flex;"><span>            &#39;task_worker_num&#39; =&gt; 10,
</span></span><span style="display:flex;"><span>            &#39;enable_coroutine&#39; =&gt; true,//æ˜¯å¦å¯ç”¨å¼‚æ­¥é£æ ¼æœåŠ¡å™¨çš„åç¨‹æ”¯æŒ
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    ],//é…ç½®é€‰é¡¹https://wiki.swoole.com/#/websocket_server?id=%e9%80%89%e9%a1%b9
</span></span><span style="display:flex;"><span>    &#39;process&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\Process::class, &#39;addProcess&#39;]
</span></span><span style="display:flex;"><span>    ],//æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„å·¥ä½œè¿›ç¨‹ https://wiki.swoole.com/#/server/methods?id=addprocess
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="43é…ç½®è¯»å–ç¤ºä¾‹"><strong>4.3é…ç½®è¯»å–ç¤ºä¾‹</strong> <a href="#43%e9%85%8d%e7%bd%ae%e8%af%bb%e5%8f%96%e7%a4%ba%e4%be%8b" class="anchor">ğŸ”—</a></h3><p>é¡¹ç›®å¯åŠ¨æ—¶åœ¨<code>apiswoole.php</code>å·²ç»é»˜è®¤æ³¨å†ŒæœåŠ¡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$di = DI();
</span></span><span style="display:flex;"><span>$di-&gt;config = new Config(&#34;./config&#34;);
</span></span></code></pre></div><p>ä¾‹å¦‚é…ç½®ä¿¡æ¯ä¸ºconf.php,ç»“æ„ä¸ºï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;debug&#39; =&gt; true,//è°ƒè¯•æ¨¡å¼
</span></span><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>å¯ä»¥ä½¿ç”¨<code>DI()-&gt;config-&gt;get('conf.tcp')</code>è¯»å–é…ç½®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DI()-&gt;config-&gt;get(&#39;conf.tcp&#39;) #è¿”å›æ•°ç»„
</span></span></code></pre></div><p>è¿”å›æ•°ç»„æ•°æ®ç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;host&#34;</span>: <span style="color:#b44">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;port&#34;</span>: <span style="color:#666">9500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;sockType&#34;</span>: <span style="color:#666">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;events&#34;</span>: [
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;receive&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;App\\Controller\\TcpServe&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;onReceive&#34;</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;settings&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="äº”æ—¥å¿—"><strong>(äº”).æ—¥å¿—</strong> <a href="#%e4%ba%94%e6%97%a5%e5%bf%97" class="anchor">ğŸ”—</a></h1><p>æ ¹æ®PSRè§„èŒƒä¸­è¯¦å°½å®šä¹‰äº†æ—¥å¿—æ¥å£ï¼Œæ—¥å¿—è®°å½•åœ¨<code>./storage/log</code>ç›®å½•ä¸­ï¼ŒæŒ‰ç…§æ¯æ—¥ç”Ÿæˆå¯¹åº”<code>æ—¥æœŸ.log</code>æ—¥å¿—æ–‡ä»¶ã€‚ç›®å‰æ”¯æŒä»¥ä¸‹å‡ ç§æ—¥å¿—è®°å½•ï¼š</p>
<ul>
<li><strong>error</strong>ï¼š ç³»ç»Ÿå¼‚å¸¸ç±»æ—¥è®°</li>
<li><strong>info</strong>ï¼š ä¸šåŠ¡çºªå½•ç±»æ—¥è®°</li>
<li><strong>debug</strong>ï¼š å¼€å‘è°ƒè¯•ç±»æ—¥è®°</li>
<li><strong>notice</strong>ï¼š ç³»ç»Ÿæç¤ºç±»æ—¥è®°</li>
<li><strong>waring</strong>ï¼š ç³»ç»Ÿè‡´å‘½ç±»æ—¥è®°</li>
</ul>
<p>æ—¥å¿—ç³»ç»Ÿä½¿ç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DI()-&gt;logger-&gt;debug(&#34;æ—¥å¿—æµ‹è¯•debug&#34;);  #å¼€å‘è°ƒè¯•ç±»æ—¥è®°
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;info(&#34;æ—¥å¿—æµ‹è¯•info&#34;);    #ä¸šåŠ¡çºªå½•ç±»æ—¥è®°
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;notice(&#34;æ—¥å¿—æµ‹è¯•notice&#34;);#ç³»ç»Ÿæç¤ºç±»æ—¥è®°
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;waring(&#34;æ—¥å¿—æµ‹è¯•waring&#34;);#ç³»ç»Ÿè‡´å‘½ç±»æ—¥è®°
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;error(&#34;æ—¥å¿—æµ‹è¯•error&#34;);  #ç³»ç»Ÿå¼‚å¸¸ç±»æ—¥è®°
</span></span></code></pre></div><p><code>./storage/log/20220906.log</code>ç›®å½•ä¸‹å¯¹åº”æ—¥å¿—ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | debug |  æ—¥å¿—æµ‹è¯•debug
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | info |  æ—¥å¿—æµ‹è¯•info
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | notice |  æ—¥å¿—æµ‹è¯•notice
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | warning |  æ—¥å¿—æµ‹è¯•waring
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | error |  æ—¥å¿—æµ‹è¯•error
</span></span></code></pre></div><h1 id="å…­httpwebsocketæœåŠ¡å™¨å‚è€ƒåœ°å€httpswikiswoolecomwebsocket_server"><strong>(å…­).HTTP/websocketæœåŠ¡å™¨<a href="https://wiki.swoole.com/#/websocket_server" target="_blank" rel="noopener">(å‚è€ƒåœ°å€)</a></strong> <a href="#%e5%85%adhttpwebsocket%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%8f%82%e8%80%83%e5%9c%b0%e5%9d%80httpswikiswoolecomwebsocket_server" class="anchor">ğŸ”—</a></h1><p><code>WebSocket\Server</code> ç»§æ‰¿è‡ª <a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">Http\Server</a>ï¼Œæ‰€ä»¥ <code>Http\Server</code> æä¾›çš„æ‰€æœ‰ <code>API</code> å’Œé…ç½®é¡¹éƒ½å¯ä»¥ä½¿ç”¨ã€‚è¯·å‚è€ƒ <a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">Http\Server</a> ç« èŠ‚ã€‚</p>
<ul>
<li>è®¾ç½®äº† <a href="https://wiki.swoole.com/#/http_server?id=on" target="_blank" rel="noopener">onRequest</a> å›è°ƒï¼Œ<code>WebSocket\Server</code> ä¹Ÿå¯ä»¥åŒæ—¶ä½œä¸º <code>HTTP</code> æœåŠ¡å™¨</li>
<li>æœªè®¾ç½® <a href="https://wiki.swoole.com/#/http_server?id=on" target="_blank" rel="noopener">onRequest</a> å›è°ƒï¼Œ<code>WebSocket\Server</code> æ”¶åˆ° <code>HTTP</code> è¯·æ±‚åä¼šè¿”å› <code>HTTP 400</code> é”™è¯¯é¡µé¢</li>
</ul>
<p>å¦‚è‹¥åªæƒ³å®ç°websocketæœåŠ¡å™¨ï¼Œåˆ™åœ¨<code>./config/conf.php</code>é…ç½®ä¸­åˆ é™¤<code>['request', \Sapi\Events::class, 'onRequest']</code>å³å¯ã€‚</p>
<h3 id="61httpwebsocketæœåŠ¡å™¨é…ç½®"><strong>6.1HTTP/websocketæœåŠ¡å™¨é…ç½®</strong> <a href="#61httpwebsocket%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h3><p>HTTP/websocketæœåŠ¡å™¨é…ç½®é€‰é¡¹åœ¨<code>./config/conf.php</code>ä¸­ã€‚å…·ä½“é…ç½®ä¿¡æ¯å¯ä»¥å‚è€ƒSwooleæ–‡æ¡£<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">é…ç½®é€‰é¡¹</a>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;ws&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//ç›‘å¬åœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9501,//ç›‘å¬ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;open&#39;, \Sapi\Events::class, &#39;onOpen&#39;],
</span></span><span style="display:flex;"><span>            [&#39;message&#39;, \Sapi\Events::class, &#39;onMessage&#39;],
</span></span><span style="display:flex;"><span>            [&#39;close&#39;, \Sapi\Events::class, &#39;onClose&#39;],
</span></span><span style="display:flex;"><span>            [&#39;request&#39;, \Sapi\Events::class, &#39;onRequest&#39;],//HTTPæœåŠ¡å™¨å›è°ƒ
</span></span><span style="display:flex;"><span>            [&#39;Task&#39;, \Sapi\Events::class, &#39;onTask&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Finish&#39;, \Sapi\Events::class, &#39;onFinish&#39;],
</span></span><span style="display:flex;"><span>            [&#39;workerStart&#39;, \Sapi\Events::class, &#39;onWorkerStart&#39;],
</span></span><span style="display:flex;"><span>            [&#39;start&#39;, \Sapi\Events::class, &#39;onStart&#39;],
</span></span><span style="display:flex;"><span>        ],//å›è°ƒå‡½æ•°
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [
</span></span><span style="display:flex;"><span>            &#39;daemonize&#39; =&gt; false,//è®¾ç½® daemonize =&gt; true æ—¶ï¼Œç¨‹åºå°†è½¬å…¥åå°ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œã€‚é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨ç«¯ç¨‹åºå¿…é¡»å¯ç”¨æ­¤é¡¹ã€‚å¦‚æœä¸å¯ç”¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå½“ ssh ç»ˆç«¯é€€å‡ºåï¼Œç¨‹åºå°†è¢«ç»ˆæ­¢è¿è¡Œ
</span></span><span style="display:flex;"><span>            &#39;worker_num&#39; =&gt; swoole_cpu_num(),
</span></span><span style="display:flex;"><span>            &#39;log_file&#39; =&gt; &#39;storage/swoole&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_rotation&#39; =&gt; SWOOLE_LOG_ROTATION_DAILY,
</span></span><span style="display:flex;"><span>            &#39;log_date_format&#39; =&gt; &#39;%Y-%m-%d %H:%M:%S&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_level&#39; =&gt; SWOOLE_LOG_DEBUG,
</span></span><span style="display:flex;"><span>            &#39;task_worker_num&#39; =&gt; 10,
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="62httpè·¯ç”±"><strong>6.2HTTPè·¯ç”±</strong> <a href="#62http%e8%b7%af%e7%94%b1" class="anchor">ğŸ”—</a></h3><p>HTTP æœåŠ¡å™¨çš„è·¯ç”±æ„å»ºæ–‡ä»¶ä½äº<code>./route/http.php</code>ä¸­ã€‚å£°æ˜å…·ä½“çš„è·¯ç”±è§„åˆ™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®šä¹‰çš„æµè§ˆå™¨è®¿é—®åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>@</code>å‰åŠéƒ¨åˆ†ä¸ºæ–‡ä»¶çš„å®Œæ•´å‘½åç©ºé—´ï¼Œ<code>@</code>ååŠéƒ¨åˆ†ä¸ºåœ¨ç±»ä¸­è°ƒç”¨çš„å…·ä½“æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/&#34;, &#34;App\Controller\App@Index&#34;),
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/hello&#34;, &#34;App\Controller\Hello@index&#34;),
</span></span><span style="display:flex;"><span>	\HttpRouter(&#34;å£°æ˜æµè§ˆå™¨åœ°å€&#34;, &#34;å‘½åç©ºé—´+ç±»@ç±»ä¸­çš„æ–¹æ³•&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p>å®Œæ•´çš„URLåœ°å€ç»„æˆ<code>http://ipç½‘å€:ç«¯å£/å®šä¹‰çš„è·¯ç”±</code>ã€‚</p>
<p>æ„å»ºåŸºæœ¬è·¯ç”±åªéœ€è¦ä¸€ä¸ª URI ä¸ä¸€ä¸ª <code>é—­åŒ…</code>ï¼Œæä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•å®šä¹‰è·¯ç”±çš„æ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/start&#34;, function (\Swoole\Http\Request $request, \Swoole\Http\Response $response) {
</span></span><span style="display:flex;"><span>        return &#39;hello&#39;;
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="63httpæ§åˆ¶å™¨"><strong>6.3HTTPæ§åˆ¶å™¨</strong> <a href="#63http%e6%8e%a7%e5%88%b6%e5%99%a8" class="anchor">ğŸ”—</a></h3><p>å¯¹åº”çš„æ§åˆ¶å™¨æ–¹æ³•é»˜è®¤æœ‰ä¸¤ä¸ªå‚æ•° <code>$request</code> å’Œ <code>$reponse</code>ï¼Œå…³äº Request å’Œ Response å¯¹è±¡å®Œæ•´çš„ä»‹ç»è¯·æŸ¥çœ‹ Swoole æ–‡æ¡£ï¼š<a href="https://wiki.swoole.com/#/http_server?id=httprequest" target="_blank" rel="noopener">Http\Request</a> ã€ <a href="https://wiki.swoole.com/#/http_server?id=httpresponse" target="_blank" rel="noopener">Http\Response</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Hello extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;code&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; &#39;hello world&#39;
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="64æ¥å£å‚æ•°è§„åˆ™"><strong>6.4æ¥å£å‚æ•°è§„åˆ™</strong> <a href="#64%e6%8e%a5%e5%8f%a3%e5%8f%82%e6%95%b0%e8%a7%84%e5%88%99" class="anchor">ğŸ”—</a></h3><p>æ¥å£å‚æ•°è§„åˆ™é€šè¿‡ç»§æ‰¿<code>Api</code>ç±»å®ç°ï¼Œå…·ä½“çš„å®šä¹‰è§„åˆ™é€šè¿‡<code>rule()</code>æ–¹æ³•ã€‚</p>
<ul>
<li>ä¸€ç»´ä¸‹æ ‡æ˜¯æ¥å£ç±»çš„æ–¹æ³•åã€‚</li>
<li>äºŒç»´ä¸‹æ ‡æ˜¯æ¥å£å‚æ•°åç§°ã€‚</li>
<li>ä¸‰ç»´ä¸‹æ ‡<code>name</code>å¯¹åº”å®¢æˆ·ç«¯ä¼ å…¥çš„å€¼ï¼Œä¸‹æ ‡<code>require</code>è¡¨ç¤ºå€¼ä¼ å…¥å¯é€‰é¡¹,<code>true</code>å¿…é¡»ä¼ å…¥ï¼Œ<code>false</code>éå¿…é¡»ä¼ å…¥ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Auth extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\Http\Request $request, \Swoole\Http\Response $response): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;login&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $request-&gt;post[&#39;username&#39;]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="65websocketè·¯ç”±"><strong>6.5websocketè·¯ç”±</strong> <a href="#65websocket%e8%b7%af%e7%94%b1" class="anchor">ğŸ”—</a></h3><p>websocketæœåŠ¡å™¨çš„è·¯ç”±å®šä¹‰æ–‡ä»¶ä½äº<code>./route/websocket.php</code>ä¸­ã€‚å£°æ˜å…·ä½“çš„è·¯ç”±è§„åˆ™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå®šä¹‰çš„æµè§ˆå™¨è®¿é—®åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>@</code>å‰åŠéƒ¨åˆ†ä¸ºæ–‡ä»¶çš„å®Œæ•´å‘½åç©ºé—´ï¼Œ<code>@</code>ååŠéƒ¨åˆ†ä¸ºåœ¨ç±»ä¸­è°ƒç”¨çš„å…·ä½“æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    WsRouter(&#34;/&#34;, &#34;\App\Controller\Websocket@index&#34;),
</span></span><span style="display:flex;"><span>    WsRouter(&#34;/login&#34;, &#34;\App\Controller\Websocket@login&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p>å®Œæ•´çš„URLåœ°å€ç»„æˆ<code> ws://ipç½‘å€:ç«¯å£</code>ã€‚</p>
<h3 id="66websocketæ§åˆ¶å™¨"><strong>6.6websocketæ§åˆ¶å™¨</strong> <a href="#66websocket%e6%8e%a7%e5%88%b6%e5%99%a8" class="anchor">ğŸ”—</a></h3><p>å¯¹åº”çš„æ§åˆ¶å™¨æ–¹æ³•é»˜è®¤æœ‰ä¸¤ä¸ªå‚æ•° <code>$server</code> å’Œ <code>$msg</code>ï¼Œå…³äº <code>$server</code>å¯¹è±¡å®Œæ•´çš„ä»‹ç»è¯·æŸ¥çœ‹ Swoole æ–‡æ¡£ï¼š<a href="https://wiki.swoole.com/#/websocket_server?id=%25e6%2596%25b9%25e6%25b3%2595" target="_blank" rel="noopener">WebSocket\Server</a>ã€‚ <code>$msg</code>æ˜¯å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ä¿¡æ¯ã€‚</p>
<h5 id="è¡¥å……websocketå®¢æˆ·ç«¯æ¶ˆæ¯ä¼ å…¥æ ¼å¼"><strong>è¡¥å……ï¼šwebsocketå®¢æˆ·ç«¯æ¶ˆæ¯ä¼ å…¥æ ¼å¼</strong> <a href="#%e8%a1%a5%e5%85%85websocket%e5%ae%a2%e6%88%b7%e7%ab%af%e6%b6%88%e6%81%af%e4%bc%a0%e5%85%a5%e6%a0%bc%e5%bc%8f" class="anchor">ğŸ”—</a></h5><p>å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ä¿¡æ¯ï¼Œé»˜è®¤éœ€ä»¥jsonæ ¼å¼ä¼ é€ï¼Œå¿…é¡»åŒ…å«idã€pathã€dataä¸‰ä¸ªå­—æ®µã€‚</p>
<ul>
<li><code>id</code>å­—æ®µæ¶ˆæ¯ä½“çš„å”¯ä¸€æ ‡è¯†ã€‚</li>
<li><code>path</code>å­—æ®µæ˜¯<code>./route/websocket.php</code>è·¯ç”±å£°æ˜çš„è®¿é—®åœ°å€ã€‚</li>
<li><code>data</code>å­—æ®µæ˜¯é¡¹ç›®çš„å…·ä½“æ¶ˆæ¯å‚æ•°ï¼Œæ§åˆ¶æ–¹æ³•é»˜è®¤çš„<code>$msg</code>ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;id&#34;</span>:<span style="color:#b44">&#34;918wsEMQDrj0RXxm&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;path&#34;</span>:<span style="color:#b44">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;username&#34;</span>: <span style="color:#b44">&#34;api-swoole&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æ§åˆ¶å™¨ä»£ç éƒ¨åˆ†ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Websocket extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index(\Swoole\WebSocket\Server $server, array $msg): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;err&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;name&#39; =&gt; &#39;api-swoole&#39;,
</span></span><span style="display:flex;"><span>                &#39;version&#39; =&gt; &#39;1.0.0&#39;,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="67websocketæ¥å£å‚æ•°è§„åˆ™"><strong>6.7websocketæ¥å£å‚æ•°è§„åˆ™</strong> <a href="#67websocket%e6%8e%a5%e5%8f%a3%e5%8f%82%e6%95%b0%e8%a7%84%e5%88%99" class="anchor">ğŸ”—</a></h3><p>æ¥å£å‚æ•°è§„åˆ™é€šè¿‡ç»§æ‰¿<code>Api</code>ç±»å®ç°ï¼Œå…·ä½“çš„å®šä¹‰è§„åˆ™é€šè¿‡<code>rule()</code>æ–¹æ³•ã€‚</p>
<ul>
<li>ä¸€ç»´ä¸‹æ ‡æ˜¯æ¥å£ç±»çš„æ–¹æ³•åã€‚</li>
<li>äºŒç»´ä¸‹æ ‡æ˜¯æ¥å£å‚æ•°åç§°ã€‚</li>
<li>ä¸‰ç»´ä¸‹æ ‡<code>name</code>å¯¹åº”å®¢æˆ·ç«¯ä¼ å…¥çš„å€¼ï¼Œä¸‹æ ‡<code>require</code>è¡¨ç¤ºå€¼ä¼ å…¥å¯é€‰é¡¹,<code>true</code>å¿…é¡»ä¼ å…¥ï¼Œ<code>false</code>éå¿…é¡»ä¼ å…¥ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Websocket extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\WebSocket\Server $server, array $msg): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;err&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $msg[&#39;username&#39;],
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="68httpwebsocketå‹¾å­å‡½æ•°"><strong>6.8http/websocketå‹¾å­å‡½æ•°</strong> <a href="#68httpwebsocket%e5%8b%be%e5%ad%90%e5%87%bd%e6%95%b0" class="anchor">ğŸ”—</a></h3><p><code>Api</code>ç±»å†…ç½®äº†é’©å­å‡½æ•°<code>userCheck</code>,HTTP/websocketæ§åˆ¶å™¨å‡å¯ç»§æ‰¿<code>Api</code>ç±»é‡è½½ã€‚ä¾‹å¦‚å¯å®Œæˆç”¨æˆ·èº«ä»½éªŒè¯ã€‚</p>
<p>é¦–å…ˆå®šä¹‰å£°æ˜<code>Base.php</code>æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Base extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    //ç”¨æˆ·æƒé™éªŒè¯
</span></span><span style="display:flex;"><span>    public function userCheck()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        if (true) {
</span></span><span style="display:flex;"><span>            return &#34;tokenè¿‡æœŸ&#34;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åç»§æ‰¿<code>Base.php</code>å®ç°ç±»é‡è½½ï¼Œã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Auth extends Base
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\Http\Request $request, \Swoole\Http\Response $response): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;login&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $request-&gt;post[&#39;username&#39;]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="ä¸ƒtcpudpæœåŠ¡å™¨"><strong>(ä¸ƒ).TCP/UDPæœåŠ¡å™¨</strong> <a href="#%e4%b8%83tcpudp%e6%9c%8d%e5%8a%a1%e5%99%a8" class="anchor">ğŸ”—</a></h1><p><code>Server</code> å¯ä»¥ç›‘å¬å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£éƒ½å¯ä»¥è®¾ç½®ä¸åŒçš„åè®®å¤„ç†æ–¹å¼ï¼Œä¾‹å¦‚ 80 ç«¯å£å¤„ç† HTTP åè®®ï¼Œ9500 ç«¯å£å¤„ç† TCP åè®®,9502 ç«¯å£å¤„ç† UDP åè®®ã€‚<code>SSL/TLS</code> ä¼ è¾“åŠ å¯†ä¹Ÿå¯ä»¥åªå¯¹ç‰¹å®šçš„ç«¯å£å¯ç”¨ã€‚å‚è€ƒSwooleå®˜æ–¹æ–‡æ¡£<a href="https://wiki.swoole.com/#/server/port" target="_blank" rel="noopener">(å¤šç«¯å£ç›‘å¬)</a></p>
<h3 id="71tcpæœåŠ¡å™¨é…ç½®"><strong>7.1TCPæœåŠ¡å™¨é…ç½®</strong> <a href="#71tcp%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h3><p>TCPæœåŠ¡å™¨é…ç½®é€‰é¡¹åœ¨<code>./config/conf.php</code>ä¸­å¢åŠ <strong>tcp</strong>å­—æ®µã€‚å…·ä½“é…ç½®ä¿¡æ¯å¯ä»¥å‚è€ƒSwooleæ–‡æ¡£<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">TCPé…ç½®ã€‚</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],//TCPæœåŠ¡å™¨å›è°ƒ
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><h3 id="71udpæœåŠ¡å™¨é…ç½®"><strong>7.1UDPæœåŠ¡å™¨é…ç½®</strong> <a href="#71udp%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h3><p>UDPæœåŠ¡å™¨é…ç½®é€‰é¡¹åœ¨<code>./config/conf.php</code>ä¸­å¢åŠ <strong>udp</strong>å­—æ®µã€‚å…·ä½“é…ç½®ä¿¡æ¯å¯ä»¥å‚è€ƒSwooleæ–‡æ¡£<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">UDPé…ç½®ã€‚</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    &#39;udp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9502,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_UDP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;packet&#39;, \App\Controller\UdpServe::class, &#39;onPacket&#39;],//UDPæœåŠ¡å™¨å›è°ƒ
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><h1 id="å…«æ•°æ®åº“"><strong>(å…«).æ•°æ®åº“</strong> <a href="#%e5%85%ab%e6%95%b0%e6%8d%ae%e5%ba%93" class="anchor">ğŸ”—</a></h1><p>Swoole å¼€å‘ç»„é‡‡ç”¨ Hook åŸç”Ÿ PHP å‡½æ•°çš„æ–¹å¼å®ç°åç¨‹å®¢æˆ·ç«¯ï¼Œé€šè¿‡ä¸€è¡Œä»£ç å°±å¯ä»¥è®©åŸæ¥çš„åŒæ­¥ IO çš„ä»£ç å˜æˆå¯ä»¥åç¨‹è°ƒåº¦çš„å¼‚æ­¥ IOï¼Œå³ä¸€é”®åç¨‹åŒ–ã€‚<code>Swoole</code> æä¾›çš„ <a href="https://wiki.swoole.com/#/server/init" target="_blank" rel="noopener">Swoole\Server ç±»ç°‡</a>éƒ½æ˜¯è‡ªåŠ¨åšå¥½çš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨åšï¼Œå‚è€ƒ <a href="https://wiki.swoole.com/#/server/setting?id=enable_coroutine" target="_blank" rel="noopener">enable_coroutine</a>ã€‚å…·ä½“å†…å®¹å¯å‚è€ƒSwooleå®˜ç½‘<a href="https://wiki.swoole.com/#/runtime" target="_blank" rel="noopener">ä¸€é”®åç¨‹åŒ–</a></p>
<p>æ¡†æ¶æ•°æ®åº“å¼•å…¥<code>simple-swoole</code>ç¬¬ä¸‰æ–¹æ‹“å±•åŒ…å…·ä½“è¯¦æƒ…å¯å‚è€ƒ<a href="https://github.com/simple-swoole/db" target="_blank" rel="noopener">simple-swoole/db</a></p>
<h3 id="81redis"><strong>8.1Redis</strong> <a href="#81redis" class="anchor">ğŸ”—</a></h3><h4 id="é…ç½®"><strong>é…ç½®</strong> <a href="#%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h4><p>RedisæœåŠ¡å™¨é…ç½®é€‰é¡¹åœ¨<code>./config/db.php</code>ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;redis&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;192.168.0.105&#39;,//RedisæœåŠ¡å™¨åœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 6379,//æŒ‡å®š Redis ç›‘å¬ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;auth&#39; =&gt; &#39;&#39;,//ç™»å½•å¯†ç 
</span></span><span style="display:flex;"><span>        &#39;db_index&#39; =&gt; 2,//æŒ‡å®šæ•°æ®åº“
</span></span><span style="display:flex;"><span>        &#39;time_out&#39; =&gt; 1,//
</span></span><span style="display:flex;"><span>        &#39;size&#39; =&gt; 64,//è¿æ¥æ± æ•°é‡
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h4 id="ä½¿ç”¨"><strong>ä½¿ç”¨</strong> <a href="#%e4%bd%bf%e7%94%a8" class="anchor">ğŸ”—</a></h4><p>é¡¹ç›®ä¸­ä½¿ç”¨Redis</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use App\Ext\Redis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class RedisDemo
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function setData(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $redis = new \Simps\DB\BaseRedis();
</span></span><span style="display:flex;"><span>        $res = $redis-&gt;set(&#39;æˆ‘æ˜¯key&#39;, &#39;æˆ‘æ˜¯value&#39;);
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;hello World!&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;key&#39; =&gt; $request-&gt;get[&#39;key&#39;],
</span></span><span style="display:flex;"><span>                &#39;val&#39; =&gt; $request-&gt;get[&#39;val&#39;],
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="82mysql"><strong>8.2MySQL</strong> <a href="#82mysql" class="anchor">ğŸ”—</a></h3><h5 id="821é…ç½®"><strong>8.2.1é…ç½®</strong> <a href="#821%e9%85%8d%e7%bd%ae" class="anchor">ğŸ”—</a></h5><p>MySQLæœåŠ¡å™¨é…ç½®é€‰é¡¹åœ¨<code>./config/db.php</code>ä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;mysql&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;&#39;,//è¿æ¥åœ°å€
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; ,//è¿æ¥ç«¯å£
</span></span><span style="display:flex;"><span>        &#39;database&#39; =&gt; &#39;&#39;,//æ•°æ®åº“åç§°
</span></span><span style="display:flex;"><span>        &#39;username&#39; =&gt; &#39;root&#39;,//ç”¨æˆ·
</span></span><span style="display:flex;"><span>        &#39;password&#39; =&gt; &#39;&#39;,//å¯†ç 
</span></span><span style="display:flex;"><span>        &#39;charset&#39; =&gt; &#39;utf8&#39;,//å­—ç¬¦é›†
</span></span><span style="display:flex;"><span>        &#39;unixSocket&#39; =&gt; null,//
</span></span><span style="display:flex;"><span>        &#39;options&#39; =&gt; [
</span></span><span style="display:flex;"><span>            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;size&#39; =&gt; 64 // è¿æ¥æ± æ•°é‡
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p><code>./app/Ext/Pool.php</code>é…ç½®è¿æ¥æ± ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Ext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Singleton;
</span></span><span style="display:flex;"><span>use Simps\DB\PDO;
</span></span><span style="display:flex;"><span>use Simps\DB\Redis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Pool
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    use Singleton;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function startPool(...$args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $mysql_config = DI()-&gt;config-&gt;get(&#39;db.mysql&#39;);
</span></span><span style="display:flex;"><span>        if (!empty($mysql_config)) {
</span></span><span style="display:flex;"><span>            PDO::getInstance($mysql_config);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $redis_config = DI()-&gt;config-&gt;get(&#39;db.redis&#39;);
</span></span><span style="display:flex;"><span>        if (!empty($redis_config)) {
</span></span><span style="display:flex;"><span>            Redis::getInstance($redis_config);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="822medoo"><strong>8.2.2Medoo</strong> <a href="#822medoo" class="anchor">ğŸ”—</a></h5><p><code>simple-swoole</code>é›†æˆäº†è½»é‡çº§çš„ PHP æ•°æ®åº“æ¡†æ¶ <a href="https://medoo.lvtao.net/index.php" target="_blank" rel="noopener">Medoo</a> ï¼Œä½¿ç”¨æ—¶éœ€è¦ç»§æ‰¿ <code>Simps\DB\BaseModel</code>ï¼Œæ‰€ä»¥ä½¿ç”¨æ–¹æ³•å’Œ Medoo åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“è¯·æŸ¥çœ‹ <a href="https://medoo.lvtao.net/1.2/doc.php" target="_blank" rel="noopener">Medoo çš„æ–‡æ¡£</a></p>
<p>å”¯ä¸€ä¸åŒçš„æ˜¯äº‹åŠ¡ç›¸å…³æ“ä½œï¼Œåœ¨ Medoo ä¸­æ˜¯ä½¿ç”¨ <code>action( $callback )</code> æ–¹æ³•ï¼Œè€Œåœ¨æœ¬æ¡†æ¶ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>action( $callback )</code> æ–¹æ³•ï¼Œå¦å¤–ä¹Ÿæ”¯æŒä»¥ä¸‹æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>beginTransaction(); // å¼€å¯äº‹åŠ¡
</span></span><span style="display:flex;"><span>commit(); // æäº¤äº‹åŠ¡
</span></span><span style="display:flex;"><span>rollBack(); // å›æ»šäº‹åŠ¡
</span></span></code></pre></div><p>äº‹åŠ¡ç¤ºä¾‹</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$this-&gt;beginTransaction();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$this-&gt;insert(&#34;user&#34;, [
</span></span><span style="display:flex;"><span>    &#34;name&#34; =&gt; &#34;luffy&#34;,
</span></span><span style="display:flex;"><span>    &#34;gender&#34; =&gt; &#34;1&#34;
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$this-&gt;delete(&#34;user&#34;, [
</span></span><span style="display:flex;"><span>    &#34;id&#34; =&gt; 2
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>if ($this-&gt;has(&#34;user&#34;, [&#34;id&#34; =&gt; 23]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $this-&gt;rollBack();
</span></span><span style="display:flex;"><span>} else {
</span></span><span style="display:flex;"><span>    $this-&gt;commit();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="823ä½¿ç”¨"><strong>8.2.3ä½¿ç”¨</strong> <a href="#823%e4%bd%bf%e7%94%a8" class="anchor">ğŸ”—</a></h4><p>é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œæ•°æ®åº“è¡¨ç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#666">`</span>user_info<span style="color:#666">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">`</span>uid<span style="color:#666">`</span><span style="color:#bbb"> </span><span style="color:#0b0;font-weight:bold">int</span>(<span style="color:#666">11</span>)<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#800">NULL</span><span style="color:#bbb"> </span><span style="color:#a2f">AUTO_INCREMENT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">`</span>nick<span style="color:#666">`</span><span style="color:#bbb"> </span><span style="color:#0b0;font-weight:bold">varchar</span>(<span style="color:#666">15</span>)<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#800">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#666">`</span>uid<span style="color:#666">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span><span style="color:#a2f">ENGINE</span><span style="color:#666">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#a2f">AUTO_INCREMENT</span><span style="color:#666">=</span><span style="color:#666">1000001</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#a2f">CHARSET</span><span style="color:#666">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MysqlDemo
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function getOne(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>        $res = $database-&gt;select(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34;,
</span></span><span style="display:flex;"><span>            &#34;nick&#34;,
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo getOne&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function save(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $username = $request-&gt;post[&#39;username&#39;];
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>        $last_user_id = $database-&gt;insert(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; time(),
</span></span><span style="display:flex;"><span>            &#34;nick&#34; =&gt; $username,
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo save&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;last_user_id&#39; =&gt; $last_user_id,
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $username,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function del(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $res = $database-&gt;delete(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo del&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function update(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>        $username = $request-&gt;post[&#39;username&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $res = $database-&gt;update(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;nick&#34; =&gt; $username
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo update&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $username,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="ä¹addprocess"><strong>(ä¹).addProcess</strong> <a href="#%e4%b9%9daddprocess" class="anchor">ğŸ”—</a></h1><p>æ·»åŠ ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„å·¥ä½œè¿›ç¨‹ã€‚æ­¤å‡½æ•°é€šå¸¸ç”¨äºåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å·¥ä½œè¿›ç¨‹ï¼Œç”¨äºç›‘æ§ã€ä¸ŠæŠ¥æˆ–è€…å…¶ä»–ç‰¹æ®Šçš„ä»»åŠ¡ã€‚å…·ä½“å†…å®¹å¯å‚è€ƒSwooleå®˜ç½‘<a href="https://wiki.swoole.com/#/server/methods?id=addprocess" target="_blank" rel="noopener"><strong>addProcess</strong></a></p>
<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<ul>
<li>åˆ›å»ºçš„å­è¿›ç¨‹å¯ä»¥è°ƒç”¨ <code>$server</code> å¯¹è±¡æä¾›çš„å„ä¸ªæ–¹æ³•ï¼Œå¦‚ <code>getClientList/getClientInfo/stats</code></li>
<li>åœ¨ <code>Worker/Task</code> è¿›ç¨‹ä¸­å¯ä»¥è°ƒç”¨ <code>$process</code> æä¾›çš„æ–¹æ³•ä¸å­è¿›ç¨‹è¿›è¡Œé€šä¿¡</li>
<li>åœ¨ç”¨æˆ·è‡ªå®šä¹‰è¿›ç¨‹ä¸­å¯ä»¥è°ƒç”¨ <code>$server-&gt;sendMessage</code> ä¸ <code>Worker/Task</code> è¿›ç¨‹é€šä¿¡</li>
<li>ç”¨æˆ·è¿›ç¨‹å†…ä¸èƒ½ä½¿ç”¨ <code>Server-&gt;task/taskwait</code> æ¥å£</li>
<li>ç”¨æˆ·è¿›ç¨‹å†…å¯ä»¥ä½¿ç”¨ <code>Server-&gt;send/close</code> ç­‰æ¥å£</li>
<li>ç”¨æˆ·è¿›ç¨‹å†…åº”å½“è¿›è¡Œ <code>while(true)</code>(å¦‚ä¸‹è¾¹çš„ç¤ºä¾‹) æˆ– <a href="https://wiki.swoole.com/#/learn?id=%e4%bb%80%e4%b9%88%e6%98%afeventloop" target="_blank" rel="noopener">EventLoop</a> å¾ªç¯ (ä¾‹å¦‚åˆ›å»ºä¸ªå®šæ—¶å™¨)ï¼Œå¦åˆ™ç”¨æˆ·è¿›ç¨‹ä¼šä¸åœåœ°é€€å‡ºé‡å¯</li>
</ul>
<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>
<p>æ·»åŠ ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰çš„å·¥ä½œè¿›ç¨‹ï¼Œåœ¨<code>./config/conf.php</code>ä¸­å¢åŠ <code>process</code>é…ç½®ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&#39;process&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\Process::class, &#39;addProcess&#39;]
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><p>æ§åˆ¶å™¨ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Process
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    //æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰çš„å·¥ä½œè¿›ç¨‹
</span></span><span style="display:flex;"><span>    public function addProcess($server)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return new \Swoole\Process(function ($process) use ($server) {
</span></span><span style="display:flex;"><span>            while (true) {
</span></span><span style="display:flex;"><span>                \Co::sleep(1);
</span></span><span style="display:flex;"><span>                echo &#34;Hello, api-swoole!\r\n&#34;;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }, false, 2, 1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="åè®¢åˆ¶äº‹ä»¶æ³¨å†Œ"><strong>(å).è®¢åˆ¶äº‹ä»¶æ³¨å†Œ</strong> <a href="#%e5%8d%81%e8%ae%a2%e5%88%b6%e4%ba%8b%e4%bb%b6%e6%b3%a8%e5%86%8c" class="anchor">ğŸ”—</a></h1><p>æ¡†æ¶å·²é»˜è®¤åŸ‹ç‚¹<code>workerStartã€openã€closeã€taskã€finish</code>äº”ä¸ªè®¢åˆ¶äº‹ä»¶æ³¨å†Œã€‚å¯æ ¹æ®å…·ä½“çš„ä¸šåŠ¡ç‰¹å¾åœ¨å¯¹åº”çš„äº‹ä»¶å›è°ƒå¢åŠ å¤„ç†ä¸šåŠ¡ä»£ç ï¼Œ<code>./confg/events.php</code>ï¼Œæ¯ä¸ªäº‹ä»¶å…è®¸æœ‰å¤šä¸ªå›è°ƒã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;workerStart&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Ext\Pool::class, &#39;startPool&#39;],//å¯åŠ¨è¿æ¥æ± 
</span></span><span style="display:flex;"><span>//        [\App\Controller\EventsDemo::class, &#39;workerStart&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;open&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;open&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;close&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;close&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;task&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;task&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;finish&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;finish&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div>
    </div>

    
        <div class="tags">
            
                <a href="https://liutongke.github.io/tags/api">api</a>
            
                <a href="https://liutongke.github.io/tags/swoole">swoole</a>
            
                <a href="https://liutongke.github.io/tags/websocket">websocket</a>
            
                <a href="https://liutongke.github.io/tags/tcp">tcp</a>
            
                <a href="https://liutongke.github.io/tags/udp">udp</a>
            
                <a href="https://liutongke.github.io/tags/http">http</a>
            
                <a href="https://liutongke.github.io/tags/php">php</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/liutongke" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>


</div>

    

    <div class="copyright">
    
        Copyright Â© 2017-2022
    
    </div>

    
    
    <div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
  </span>
        <span id="busuanzi_container_site_uv">
    æ€»è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
  </span>
    </div>
    
</footer>



  </body>
</html>

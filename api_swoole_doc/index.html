<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>api-swoole框架文档 | keke的个人博客</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="api-swoole框架文档">



  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your-google-analytics-id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">

  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>首页</a>
	
	<a href="/posts">归档</a>
	<a href="/tags">标签</a>
	<a href="/about">关于</a>

	

	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">api-swoole框架文档</h1>

    <div class="tip">
        <time datetime="2022-09-10 00:00:00 &#43;0000 UTC">2022年09月10日</time>
        <span class="split">
          ·
        </span>
        <span>
          6754字
        </span>
        <span class="split">
          ·
        </span>
        <span>
          14分钟
        </span>
        <span class="split">
          ·
        </span>
        <span>
          <span id="busuanzi_container_page_pv">阅读量<span id="busuanzi_value_page_pv"></span>次</span>
        </span>
    </div>

    
    
        
  
    <aside class="toc">
      <details>
          <summary>Table of Contents
          </summary>
          <div>
              <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#11下载与安装"><strong>1.1下载与安装</strong></a></li>
        <li><a href="#12通过-composer-创建项目"><strong>1.2通过 Composer 创建项目</strong></a></li>
        <li><a href="#13启动"><strong>1.3启动</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#21编写一个接口"><strong>2.1编写一个接口</strong></a></li>
        <li><a href="#22定义路由"><strong>2.2定义路由</strong></a></li>
        <li><a href="#23启动项目"><strong>2.3启动项目</strong></a></li>
        <li><a href="#24访问接口"><strong>2.4访问接口</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#41配置文件"><strong>4.1配置文件</strong></a></li>
        <li><a href="#42参数说明"><strong>4.2参数说明</strong></a></li>
        <li><a href="#43配置读取示例"><strong>4.3配置读取示例</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#61httpwebsocket服务器配置"><strong>6.1HTTP/websocket服务器配置</strong></a></li>
        <li><a href="#62http路由"><strong>6.2HTTP路由</strong></a></li>
        <li><a href="#63http控制器"><strong>6.3HTTP控制器</strong></a></li>
        <li><a href="#64接口参数规则"><strong>6.4接口参数规则</strong></a></li>
        <li><a href="#65websocket路由"><strong>6.5websocket路由</strong></a></li>
        <li><a href="#66websocket控制器"><strong>6.6websocket控制器</strong></a></li>
        <li><a href="#67websocket接口参数规则"><strong>6.7websocket接口参数规则</strong></a></li>
        <li><a href="#68httpwebsocket勾子函数"><strong>6.8http/websocket勾子函数</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#71tcp服务器配置"><strong>7.1TCP服务器配置</strong></a></li>
        <li><a href="#71udp服务器配置"><strong>7.1UDP服务器配置</strong></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li>
      <ul>
        <li><a href="#81redis"><strong>8.1Redis</strong></a></li>
        <li><a href="#82mysql"><strong>8.2MySQL</strong></a></li>
      </ul>
    </li>
  </ul>
</nav>
          </div>
      </details>
    </aside>
  


    


    <div class="content">
      <h1 id="一开始"><strong>(一).开始</strong> <a href="#%e4%b8%80%e5%bc%80%e5%a7%8b" class="anchor">🔗</a></h1><h3 id="11下载与安装"><strong>1.1下载与安装</strong> <a href="#11%e4%b8%8b%e8%bd%bd%e4%b8%8e%e5%ae%89%e8%a3%85" class="anchor">🔗</a></h3><p><strong>源码地址：</strong>
<a href="https://github.com/liutongke/api-swoole" target="_blank" rel="noopener">api-swoole框架github源码地址</a>
<a href="https://gitee.com/tongke/api-swoole" target="_blank" rel="noopener">api-swoole框架gitee源码地址</a></p>
<p>需要确保运行环境达到了以下的要求：</p>
<ul>
<li>PHP &gt;= 7.4</li>
<li>Swoole PHP 扩展 &gt;= 4.5</li>
<li>Redis PHP 扩展 （如需使用 Redis 客户端）</li>
<li>PDO PHP 扩展 （如需使用 MySQL 客户端）</li>
</ul>
<h3 id="12通过-composer-创建项目"><strong>1.2通过 Composer 创建项目</strong> <a href="#12%e9%80%9a%e8%bf%87-composer-%e5%88%9b%e5%bb%ba%e9%a1%b9%e7%9b%ae" class="anchor">🔗</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>composer create-project api-swoole/skeleton
</span></span></code></pre></div><h3 id="13启动"><strong>1.3启动</strong> <a href="#13%e5%90%af%e5%8a%a8" class="anchor">🔗</a></h3><p>支持 HTTP 服务、WebSocket 服务、tcp服务,项目根目录<code>./apiswoole.php</code>执行命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>php apiswoole.php
</span></span></code></pre></div><h1 id="二hello-world"><strong>(二).Hello World</strong> <a href="#%e4%ba%8chello-world" class="anchor">🔗</a></h1><h3 id="21编写一个接口"><strong>2.1编写一个接口</strong> <a href="#21%e7%bc%96%e5%86%99%e4%b8%80%e4%b8%aa%e6%8e%a5%e5%8f%a3" class="anchor">🔗</a></h3><p>在api-swoole框架中，业务主要代码在app目录中。里面各个命名空间对应一个子目录，项目的默认命名空间是App，创建项目后app目录中包含Common、Controller、Ext三个子目录，Common目录存放函数的functions.php文件，Ext一般放置工具等。目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>└── app
</span></span><span style="display:flex;"><span>    ├── Controller # 放置接口源代码，相当于控制器层
</span></span><span style="display:flex;"><span>    ├── Common # 公共代码目录，
</span></span><span style="display:flex;"><span>    └── Ext# 放置工具等
</span></span></code></pre></div><p>当项目需要新增接口时，先在<code>./app/Controller</code>目录中新建<code>hello.php</code>文件，并用编辑器编辑代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Hello extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;code&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; &#39;hello world&#39;
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="22定义路由"><strong>2.2定义路由</strong> <a href="#22%e5%ae%9a%e4%b9%89%e8%b7%af%e7%94%b1" class="anchor">🔗</a></h3><p>在<code>route/http.php</code>路由文件中定义项目路由，第一个参数为定义的浏览器访问地址，第二个参数<code>@</code>前半部分为文件的完整命名空间，<code>@</code>后半部分为在类中调用的具体方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/hello&#34;, &#34;App\Controller\Hello@index&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="23启动项目"><strong>2.3启动项目</strong> <a href="#23%e5%90%af%e5%8a%a8%e9%a1%b9%e7%9b%ae" class="anchor">🔗</a></h3><p>在项目根目录下执行如下命令以非守护模式启动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>php apiswoole.php
</span></span></code></pre></div><p>默认情况下监听本地的HTTP和websocket的9501端口，在cmd中出现如下输出信息表示项目启动成功。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[Success] Swoole: 4.5.9, PHP: 7.4.13, Port: 9501
</span></span><span style="display:flex;"><span>[Success] Swoole Http Server running：http://0.0.0.0:9501
</span></span><span style="display:flex;"><span>[Success] Swoole websocket Server running：ws://0.0.0.0:9501
</span></span><span style="display:flex;"><span>[Success] Swoole tcp Server running：0.0.0.0:9500
</span></span><span style="display:flex;"><span>[Success] Swoole udp Server running：0.0.0.0:9502
</span></span></code></pre></div><h3 id="24访问接口"><strong>2.4访问接口</strong> <a href="#24%e8%ae%bf%e9%97%ae%e6%8e%a5%e5%8f%a3" class="anchor">🔗</a></h3><p>在浏览器地址栏中输入定义的路由地址，地址组成<code>http://ip网址:端口/定义的路由</code>。</p>
<p><code>http://127.0.0.1:9501/hello</code></p>
<p>请求成功返回数据默认json方式返回，包含默认的code、msg、data字段，data中数据为方法中返回的数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>: <span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;msg&#34;</span>: <span style="color:#b44">&#34;success&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>: <span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: <span style="color:#b44">&#34;hello world&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="三反向代理nginx--swoole-配置"><strong>(三).反向代理（Nginx + Swoole 配置）</strong> <a href="#%e4%b8%89%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86nginx--swoole-%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h1><p>由于 <code>Http\Server</code> 对 <code>HTTP</code> 协议的支持并不完整，建议仅作为应用服务器，用于处理动态请求，并且在前端增加 <code>Nginx</code> 作为代理。（<a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">参考地址</a>）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>server {
</span></span><span style="display:flex;"><span>    listen 80;
</span></span><span style="display:flex;"><span>    server_name swoole.test;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    location / {
</span></span><span style="display:flex;"><span>        proxy_set_header Host $http_host;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Real-IP $remote_addr;
</span></span><span style="display:flex;"><span>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        proxy_pass http://127.0.0.1:9501;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以通过读取 <code>$request-&gt;header['x-real-ip']</code> 来获取客户端的真实 <code>IP</code></p>
<h1 id="四配置"><strong>(四).配置</strong> <a href="#%e5%9b%9b%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h1><h3 id="41配置文件"><strong>4.1配置文件</strong> <a href="#41%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" class="anchor">🔗</a></h3><p>默认config文件夹下包含conf.php、db.php、events.php三个文件，conf.php放置项目的配置信息，http、tcp、udp、websocket等配置。db.php负责配置MySQL、Redis连接，events.php负责定义定制特定事件注册监听，现支持<code>workerStart、open、close、task、finish</code>事件注册 。可以通过<code>DI()-&gt;config-&gt;get('conf.ws')</code>或者<code>\Sapi\Di::one()-&gt;config-&gt;get('conf.ws')</code>方式读取配置信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>./config/
</span></span><span style="display:flex;"><span>├── conf.php #http、tcp、udp、websocket等配置
</span></span><span style="display:flex;"><span>├── db.php #数据库配置
</span></span><span style="display:flex;"><span>└── events.php #定制特定事件注册监听
</span></span></code></pre></div><h3 id="42参数说明"><strong>4.2参数说明</strong> <a href="#42%e5%8f%82%e6%95%b0%e8%af%b4%e6%98%8e" class="anchor">🔗</a></h3><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;debug&#39; =&gt; true,//true 调试模式 false 关闭调试
</span></span><span style="display:flex;"><span>    &#39;log&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;displayConsole&#39; =&gt; true,//控制台打印日志，true打开 false 关闭
</span></span><span style="display:flex;"><span>        &#39;saveLog&#39; =&gt; true,//保存日志 true 打开 false 关闭
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;udp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//指定监听的ip地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9502,//指定监听端口
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_UDP,//指定这组 Server 的类型
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;packet&#39;, \App\Controller\UdpServe::class, &#39;onPacket&#39;],//回调事件
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],//配置选项https://wiki.swoole.com/#/server/setting
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//指定监听的ip地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9501,//指定监听端口
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,//指定这组 Server 的类型
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],//回调事件
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],//配置选项https://wiki.swoole.com/#/server/setting
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;ws&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//指定监听的ip地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,//指定监听端口
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,//指定这组 Server 的类型
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;open&#39;, \Sapi\Events::class, &#39;onOpen&#39;],
</span></span><span style="display:flex;"><span>            [&#39;message&#39;, \Sapi\Events::class, &#39;onMessage&#39;],
</span></span><span style="display:flex;"><span>            [&#39;close&#39;, \Sapi\Events::class, &#39;onClose&#39;],
</span></span><span style="display:flex;"><span>            [&#39;request&#39;, \Sapi\Events::class, &#39;onRequest&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Task&#39;, \Sapi\Events::class, &#39;onTask&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Finish&#39;, \Sapi\Events::class, &#39;onFinish&#39;],
</span></span><span style="display:flex;"><span>            [&#39;workerStart&#39;, \Sapi\Events::class, &#39;onWorkerStart&#39;],
</span></span><span style="display:flex;"><span>            [&#39;start&#39;, \Sapi\Events::class, &#39;onStart&#39;],
</span></span><span style="display:flex;"><span>        ],//回调事件
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [
</span></span><span style="display:flex;"><span>            &#39;daemonize&#39; =&gt; false,//设置 daemonize =&gt; true 时，程序将转入后台作为守护进程运行。长时间运行的服务器端程序必须启用此项。如果不启用守护进程，当 ssh 终端退出后，程序将被终止运行
</span></span><span style="display:flex;"><span>            &#39;worker_num&#39; =&gt; swoole_cpu_num(),
</span></span><span style="display:flex;"><span>            &#39;log_file&#39; =&gt; &#39;storage/swoole&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_rotation&#39; =&gt; SWOOLE_LOG_ROTATION_DAILY,
</span></span><span style="display:flex;"><span>            &#39;log_date_format&#39; =&gt; &#39;%Y-%m-%d %H:%M:%S&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_level&#39; =&gt; SWOOLE_LOG_DEBUG,
</span></span><span style="display:flex;"><span>            &#39;task_worker_num&#39; =&gt; 10,
</span></span><span style="display:flex;"><span>            &#39;enable_coroutine&#39; =&gt; true,//是否启用异步风格服务器的协程支持
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    ],//配置选项https://wiki.swoole.com/#/websocket_server?id=%e9%80%89%e9%a1%b9
</span></span><span style="display:flex;"><span>    &#39;process&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\Process::class, &#39;addProcess&#39;]
</span></span><span style="display:flex;"><span>    ],//添加用户自定义的工作进程 https://wiki.swoole.com/#/server/methods?id=addprocess
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="43配置读取示例"><strong>4.3配置读取示例</strong> <a href="#43%e9%85%8d%e7%bd%ae%e8%af%bb%e5%8f%96%e7%a4%ba%e4%be%8b" class="anchor">🔗</a></h3><p>项目启动时在<code>apiswoole.php</code>已经默认注册服务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$di = DI();
</span></span><span style="display:flex;"><span>$di-&gt;config = new Config(&#34;./config&#34;);
</span></span></code></pre></div><p>例如配置信息为conf.php,结构为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;debug&#39; =&gt; true,//调试模式
</span></span><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p>可以使用<code>DI()-&gt;config-&gt;get('conf.tcp')</code>读取配置文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DI()-&gt;config-&gt;get(&#39;conf.tcp&#39;) #返回数组
</span></span></code></pre></div><p>返回数组数据结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;host&#34;</span>: <span style="color:#b44">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;port&#34;</span>: <span style="color:#666">9500</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;sockType&#34;</span>: <span style="color:#666">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;events&#34;</span>: [
</span></span><span style="display:flex;"><span>        [
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;receive&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;App\\Controller\\TcpServe&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#b44">&#34;onReceive&#34;</span>
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;settings&#34;</span>: []
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="五日志"><strong>(五).日志</strong> <a href="#%e4%ba%94%e6%97%a5%e5%bf%97" class="anchor">🔗</a></h1><p>根据PSR规范中详尽定义了日志接口，日志记录在<code>./storage/log</code>目录中，按照每日生成对应<code>日期.log</code>日志文件。目前支持以下几种日志记录：</p>
<ul>
<li><strong>error</strong>： 系统异常类日记</li>
<li><strong>info</strong>： 业务纪录类日记</li>
<li><strong>debug</strong>： 开发调试类日记</li>
<li><strong>notice</strong>： 系统提示类日记</li>
<li><strong>waring</strong>： 系统致命类日记</li>
</ul>
<p>日志系统使用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>DI()-&gt;logger-&gt;debug(&#34;日志测试debug&#34;);  #开发调试类日记
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;info(&#34;日志测试info&#34;);    #业务纪录类日记
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;notice(&#34;日志测试notice&#34;);#系统提示类日记
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;waring(&#34;日志测试waring&#34;);#系统致命类日记
</span></span><span style="display:flex;"><span>DI()-&gt;logger-&gt;error(&#34;日志测试error&#34;);  #系统异常类日记
</span></span></code></pre></div><p><code>./storage/log/20220906.log</code>目录下对应日志：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | debug |  日志测试debug
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | info |  日志测试info
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | notice |  日志测试notice
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | warning |  日志测试waring
</span></span><span style="display:flex;"><span>[swoole] | [2022-09-06 01:32:05] | error |  日志测试error
</span></span></code></pre></div><h1 id="六httpwebsocket服务器参考地址httpswikiswoolecomwebsocket_server"><strong>(六).HTTP/websocket服务器<a href="https://wiki.swoole.com/#/websocket_server" target="_blank" rel="noopener">(参考地址)</a></strong> <a href="#%e5%85%adhttpwebsocket%e6%9c%8d%e5%8a%a1%e5%99%a8%e5%8f%82%e8%80%83%e5%9c%b0%e5%9d%80httpswikiswoolecomwebsocket_server" class="anchor">🔗</a></h1><p><code>WebSocket\Server</code> 继承自 <a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">Http\Server</a>，所以 <code>Http\Server</code> 提供的所有 <code>API</code> 和配置项都可以使用。请参考 <a href="https://wiki.swoole.com/#/http_server" target="_blank" rel="noopener">Http\Server</a> 章节。</p>
<ul>
<li>设置了 <a href="https://wiki.swoole.com/#/http_server?id=on" target="_blank" rel="noopener">onRequest</a> 回调，<code>WebSocket\Server</code> 也可以同时作为 <code>HTTP</code> 服务器</li>
<li>未设置 <a href="https://wiki.swoole.com/#/http_server?id=on" target="_blank" rel="noopener">onRequest</a> 回调，<code>WebSocket\Server</code> 收到 <code>HTTP</code> 请求后会返回 <code>HTTP 400</code> 错误页面</li>
</ul>
<p>如若只想实现websocket服务器，则在<code>./config/conf.php</code>配置中删除<code>['request', \Sapi\Events::class, 'onRequest']</code>即可。</p>
<h3 id="61httpwebsocket服务器配置"><strong>6.1HTTP/websocket服务器配置</strong> <a href="#61httpwebsocket%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h3><p>HTTP/websocket服务器配置选项在<code>./config/conf.php</code>中。具体配置信息可以参考Swoole文档<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">配置选项</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;ws&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,//监听地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9501,//监听端口
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;open&#39;, \Sapi\Events::class, &#39;onOpen&#39;],
</span></span><span style="display:flex;"><span>            [&#39;message&#39;, \Sapi\Events::class, &#39;onMessage&#39;],
</span></span><span style="display:flex;"><span>            [&#39;close&#39;, \Sapi\Events::class, &#39;onClose&#39;],
</span></span><span style="display:flex;"><span>            [&#39;request&#39;, \Sapi\Events::class, &#39;onRequest&#39;],//HTTP服务器回调
</span></span><span style="display:flex;"><span>            [&#39;Task&#39;, \Sapi\Events::class, &#39;onTask&#39;],
</span></span><span style="display:flex;"><span>            [&#39;Finish&#39;, \Sapi\Events::class, &#39;onFinish&#39;],
</span></span><span style="display:flex;"><span>            [&#39;workerStart&#39;, \Sapi\Events::class, &#39;onWorkerStart&#39;],
</span></span><span style="display:flex;"><span>            [&#39;start&#39;, \Sapi\Events::class, &#39;onStart&#39;],
</span></span><span style="display:flex;"><span>        ],//回调函数
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [
</span></span><span style="display:flex;"><span>            &#39;daemonize&#39; =&gt; false,//设置 daemonize =&gt; true 时，程序将转入后台作为守护进程运行。长时间运行的服务器端程序必须启用此项。如果不启用守护进程，当 ssh 终端退出后，程序将被终止运行
</span></span><span style="display:flex;"><span>            &#39;worker_num&#39; =&gt; swoole_cpu_num(),
</span></span><span style="display:flex;"><span>            &#39;log_file&#39; =&gt; &#39;storage/swoole&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_rotation&#39; =&gt; SWOOLE_LOG_ROTATION_DAILY,
</span></span><span style="display:flex;"><span>            &#39;log_date_format&#39; =&gt; &#39;%Y-%m-%d %H:%M:%S&#39;,
</span></span><span style="display:flex;"><span>            &#39;log_level&#39; =&gt; SWOOLE_LOG_DEBUG,
</span></span><span style="display:flex;"><span>            &#39;task_worker_num&#39; =&gt; 10,
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="62http路由"><strong>6.2HTTP路由</strong> <a href="#62http%e8%b7%af%e7%94%b1" class="anchor">🔗</a></h3><p>HTTP 服务器的路由构建文件位于<code>./route/http.php</code>中。声明具体的路由规则，第一个参数为定义的浏览器访问地址，第二个参数<code>@</code>前半部分为文件的完整命名空间，<code>@</code>后半部分为在类中调用的具体方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/&#34;, &#34;App\Controller\App@Index&#34;),
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/hello&#34;, &#34;App\Controller\Hello@index&#34;),
</span></span><span style="display:flex;"><span>	\HttpRouter(&#34;声明浏览器地址&#34;, &#34;命名空间+类@类中的方法&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p>完整的URL地址组成<code>http://ip网址:端口/定义的路由</code>。</p>
<p>构建基本路由只需要一个 URI 与一个 <code>闭包</code>，提供了一个非常简单定义路由的方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    \HttpRouter(&#34;/start&#34;, function (\Swoole\Http\Request $request, \Swoole\Http\Response $response) {
</span></span><span style="display:flex;"><span>        return &#39;hello&#39;;
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h3 id="63http控制器"><strong>6.3HTTP控制器</strong> <a href="#63http%e6%8e%a7%e5%88%b6%e5%99%a8" class="anchor">🔗</a></h3><p>对应的控制器方法默认有两个参数 <code>$request</code> 和 <code>$reponse</code>，关于 Request 和 Response 对象完整的介绍请查看 Swoole 文档：<a href="https://wiki.swoole.com/#/http_server?id=httprequest" target="_blank" rel="noopener">Http\Request</a> 、 <a href="https://wiki.swoole.com/#/http_server?id=httpresponse" target="_blank" rel="noopener">Http\Response</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Hello extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;code&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; &#39;hello world&#39;
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="64接口参数规则"><strong>6.4接口参数规则</strong> <a href="#64%e6%8e%a5%e5%8f%a3%e5%8f%82%e6%95%b0%e8%a7%84%e5%88%99" class="anchor">🔗</a></h3><p>接口参数规则通过继承<code>Api</code>类实现，具体的定义规则通过<code>rule()</code>方法。</p>
<ul>
<li>一维下标是接口类的方法名。</li>
<li>二维下标是接口参数名称。</li>
<li>三维下标<code>name</code>对应客户端传入的值，下标<code>require</code>表示值传入可选项,<code>true</code>必须传入，<code>false</code>非必须传入。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Auth extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\Http\Request $request, \Swoole\Http\Response $response): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;login&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $request-&gt;post[&#39;username&#39;]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="65websocket路由"><strong>6.5websocket路由</strong> <a href="#65websocket%e8%b7%af%e7%94%b1" class="anchor">🔗</a></h3><p>websocket服务器的路由定义文件位于<code>./route/websocket.php</code>中。声明具体的路由规则，第一个参数为定义的浏览器访问地址，第二个参数<code>@</code>前半部分为文件的完整命名空间，<code>@</code>后半部分为在类中调用的具体方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    WsRouter(&#34;/&#34;, &#34;\App\Controller\Websocket@index&#34;),
</span></span><span style="display:flex;"><span>    WsRouter(&#34;/login&#34;, &#34;\App\Controller\Websocket@login&#34;),
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p>完整的URL地址组成<code> ws://ip网址:端口</code>。</p>
<h3 id="66websocket控制器"><strong>6.6websocket控制器</strong> <a href="#66websocket%e6%8e%a7%e5%88%b6%e5%99%a8" class="anchor">🔗</a></h3><p>对应的控制器方法默认有两个参数 <code>$server</code> 和 <code>$msg</code>，关于 <code>$server</code>对象完整的介绍请查看 Swoole 文档：<a href="https://wiki.swoole.com/#/websocket_server?id=%25e6%2596%25b9%25e6%25b3%2595" target="_blank" rel="noopener">WebSocket\Server</a>。 <code>$msg</code>是客户端发送的数据信息。</p>
<h5 id="补充websocket客户端消息传入格式"><strong>补充：websocket客户端消息传入格式</strong> <a href="#%e8%a1%a5%e5%85%85websocket%e5%ae%a2%e6%88%b7%e7%ab%af%e6%b6%88%e6%81%af%e4%bc%a0%e5%85%a5%e6%a0%bc%e5%bc%8f" class="anchor">🔗</a></h5><p>客户端发送的数据信息，默认需以json格式传送，必须包含id、path、data三个字段。</p>
<ul>
<li><code>id</code>字段消息体的唯一标识。</li>
<li><code>path</code>字段是<code>./route/websocket.php</code>路由声明的访问地址。</li>
<li><code>data</code>字段是项目的具体消息参数，控制方法默认的<code>$msg</code>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;id&#34;</span>:<span style="color:#b44">&#34;918wsEMQDrj0RXxm&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;path&#34;</span>:<span style="color:#b44">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;data&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#008000;font-weight:bold">&#34;username&#34;</span>: <span style="color:#b44">&#34;api-swoole&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>控制器代码部分示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Websocket extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function index(\Swoole\WebSocket\Server $server, array $msg): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;err&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;name&#39; =&gt; &#39;api-swoole&#39;,
</span></span><span style="display:flex;"><span>                &#39;version&#39; =&gt; &#39;1.0.0&#39;,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="67websocket接口参数规则"><strong>6.7websocket接口参数规则</strong> <a href="#67websocket%e6%8e%a5%e5%8f%a3%e5%8f%82%e6%95%b0%e8%a7%84%e5%88%99" class="anchor">🔗</a></h3><p>接口参数规则通过继承<code>Api</code>类实现，具体的定义规则通过<code>rule()</code>方法。</p>
<ul>
<li>一维下标是接口类的方法名。</li>
<li>二维下标是接口参数名称。</li>
<li>三维下标<code>name</code>对应客户端传入的值，下标<code>require</code>表示值传入可选项,<code>true</code>必须传入，<code>false</code>非必须传入。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Websocket extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\WebSocket\Server $server, array $msg): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;err&#39; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#39;data&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $msg[&#39;username&#39;],
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="68httpwebsocket勾子函数"><strong>6.8http/websocket勾子函数</strong> <a href="#68httpwebsocket%e5%8b%be%e5%ad%90%e5%87%bd%e6%95%b0" class="anchor">🔗</a></h3><p><code>Api</code>类内置了钩子函数<code>userCheck</code>,HTTP/websocket控制器均可继承<code>Api</code>类重载。例如可完成用户身份验证。</p>
<p>首先定义声明<code>Base.php</code>文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Base extends Api
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    //用户权限验证
</span></span><span style="display:flex;"><span>    public function userCheck()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        if (true) {
</span></span><span style="display:flex;"><span>            return &#34;token过期&#34;;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后继承<code>Base.php</code>实现类重载，。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Api;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Auth extends Base
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function rule()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#39;login&#39; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; [&#39;name&#39; =&gt; &#39;username&#39;, &#39;require&#39; =&gt; true]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function login(\Swoole\Http\Request $request, \Swoole\Http\Response $response): array
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;login&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $request-&gt;post[&#39;username&#39;]
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="七tcpudp服务器"><strong>(七).TCP/UDP服务器</strong> <a href="#%e4%b8%83tcpudp%e6%9c%8d%e5%8a%a1%e5%99%a8" class="anchor">🔗</a></h1><p><code>Server</code> 可以监听多个端口，每个端口都可以设置不同的协议处理方式，例如 80 端口处理 HTTP 协议，9500 端口处理 TCP 协议,9502 端口处理 UDP 协议。<code>SSL/TLS</code> 传输加密也可以只对特定的端口启用。参考Swoole官方文档<a href="https://wiki.swoole.com/#/server/port" target="_blank" rel="noopener">(多端口监听)</a></p>
<h3 id="71tcp服务器配置"><strong>7.1TCP服务器配置</strong> <a href="#71tcp%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h3><p>TCP服务器配置选项在<code>./config/conf.php</code>中增加<strong>tcp</strong>字段。具体配置信息可以参考Swoole文档<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">TCP配置。</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    &#39;tcp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9500,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_TCP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;receive&#39;, \App\Controller\TcpServe::class, &#39;onReceive&#39;],//TCP服务器回调
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><h3 id="71udp服务器配置"><strong>7.1UDP服务器配置</strong> <a href="#71udp%e6%9c%8d%e5%8a%a1%e5%99%a8%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h3><p>UDP服务器配置选项在<code>./config/conf.php</code>中增加<strong>udp</strong>字段。具体配置信息可以参考Swoole文档<a href="https://wiki.swoole.com/#/server/setting" target="_blank" rel="noopener">UDP配置。</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>    &#39;udp&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;0.0.0.0&#39;,
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 9502,
</span></span><span style="display:flex;"><span>        &#39;sockType&#39; =&gt; SWOOLE_SOCK_UDP,
</span></span><span style="display:flex;"><span>        &#39;events&#39; =&gt; [
</span></span><span style="display:flex;"><span>            [&#39;packet&#39;, \App\Controller\UdpServe::class, &#39;onPacket&#39;],//UDP服务器回调
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;settings&#39; =&gt; [],
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><h1 id="八数据库"><strong>(八).数据库</strong> <a href="#%e5%85%ab%e6%95%b0%e6%8d%ae%e5%ba%93" class="anchor">🔗</a></h1><p>Swoole 开发组采用 Hook 原生 PHP 函数的方式实现协程客户端，通过一行代码就可以让原来的同步 IO 的代码变成可以协程调度的异步 IO，即一键协程化。<code>Swoole</code> 提供的 <a href="https://wiki.swoole.com/#/server/init" target="_blank" rel="noopener">Swoole\Server 类簇</a>都是自动做好的，不需要手动做，参考 <a href="https://wiki.swoole.com/#/server/setting?id=enable_coroutine" target="_blank" rel="noopener">enable_coroutine</a>。具体内容可参考Swoole官网<a href="https://wiki.swoole.com/#/runtime" target="_blank" rel="noopener">一键协程化</a></p>
<p>框架数据库引入<code>simple-swoole</code>第三方拓展包具体详情可参考<a href="https://github.com/simple-swoole/db" target="_blank" rel="noopener">simple-swoole/db</a></p>
<h3 id="81redis"><strong>8.1Redis</strong> <a href="#81redis" class="anchor">🔗</a></h3><h4 id="配置"><strong>配置</strong> <a href="#%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h4><p>Redis服务器配置选项在<code>./config/db.php</code>中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;redis&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;192.168.0.105&#39;,//Redis服务器地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; 6379,//指定 Redis 监听端口
</span></span><span style="display:flex;"><span>        &#39;auth&#39; =&gt; &#39;&#39;,//登录密码
</span></span><span style="display:flex;"><span>        &#39;db_index&#39; =&gt; 2,//指定数据库
</span></span><span style="display:flex;"><span>        &#39;time_out&#39; =&gt; 1,//
</span></span><span style="display:flex;"><span>        &#39;size&#39; =&gt; 64,//连接池数量
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><h4 id="使用"><strong>使用</strong> <a href="#%e4%bd%bf%e7%94%a8" class="anchor">🔗</a></h4><p>项目中使用Redis</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use App\Ext\Redis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class RedisDemo
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function setData(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $redis = new \Simps\DB\BaseRedis();
</span></span><span style="display:flex;"><span>        $res = $redis-&gt;set(&#39;我是key&#39;, &#39;我是value&#39;);
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;hello World!&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;key&#39; =&gt; $request-&gt;get[&#39;key&#39;],
</span></span><span style="display:flex;"><span>                &#39;val&#39; =&gt; $request-&gt;get[&#39;val&#39;],
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="82mysql"><strong>8.2MySQL</strong> <a href="#82mysql" class="anchor">🔗</a></h3><h5 id="821配置"><strong>8.2.1配置</strong> <a href="#821%e9%85%8d%e7%bd%ae" class="anchor">🔗</a></h5><p>MySQL服务器配置选项在<code>./config/db.php</code>中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;mysql&#39; =&gt; [
</span></span><span style="display:flex;"><span>        &#39;host&#39; =&gt; &#39;&#39;,//连接地址
</span></span><span style="display:flex;"><span>        &#39;port&#39; =&gt; ,//连接端口
</span></span><span style="display:flex;"><span>        &#39;database&#39; =&gt; &#39;&#39;,//数据库名称
</span></span><span style="display:flex;"><span>        &#39;username&#39; =&gt; &#39;root&#39;,//用户
</span></span><span style="display:flex;"><span>        &#39;password&#39; =&gt; &#39;&#39;,//密码
</span></span><span style="display:flex;"><span>        &#39;charset&#39; =&gt; &#39;utf8&#39;,//字符集
</span></span><span style="display:flex;"><span>        &#39;unixSocket&#39; =&gt; null,//
</span></span><span style="display:flex;"><span>        &#39;options&#39; =&gt; [
</span></span><span style="display:flex;"><span>            PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC,
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>        &#39;size&#39; =&gt; 64 // 连接池数量
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><p><code>./app/Ext/Pool.php</code>配置连接池：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Ext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>use Sapi\Singleton;
</span></span><span style="display:flex;"><span>use Simps\DB\PDO;
</span></span><span style="display:flex;"><span>use Simps\DB\Redis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Pool
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    use Singleton;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function startPool(...$args)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $mysql_config = DI()-&gt;config-&gt;get(&#39;db.mysql&#39;);
</span></span><span style="display:flex;"><span>        if (!empty($mysql_config)) {
</span></span><span style="display:flex;"><span>            PDO::getInstance($mysql_config);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $redis_config = DI()-&gt;config-&gt;get(&#39;db.redis&#39;);
</span></span><span style="display:flex;"><span>        if (!empty($redis_config)) {
</span></span><span style="display:flex;"><span>            Redis::getInstance($redis_config);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="822medoo"><strong>8.2.2Medoo</strong> <a href="#822medoo" class="anchor">🔗</a></h5><p><code>simple-swoole</code>集成了轻量级的 PHP 数据库框架 <a href="https://medoo.lvtao.net/index.php" target="_blank" rel="noopener">Medoo</a> ，使用时需要继承 <code>Simps\DB\BaseModel</code>，所以使用方法和 Medoo 基本一致，具体请查看 <a href="https://medoo.lvtao.net/1.2/doc.php" target="_blank" rel="noopener">Medoo 的文档</a></p>
<p>唯一不同的是事务相关操作，在 Medoo 中是使用 <code>action( $callback )</code> 方法，而在本框架中也可以使用 <code>action( $callback )</code> 方法，另外也支持以下方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>beginTransaction(); // 开启事务
</span></span><span style="display:flex;"><span>commit(); // 提交事务
</span></span><span style="display:flex;"><span>rollBack(); // 回滚事务
</span></span></code></pre></div><p>事务示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$this-&gt;beginTransaction();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$this-&gt;insert(&#34;user&#34;, [
</span></span><span style="display:flex;"><span>    &#34;name&#34; =&gt; &#34;luffy&#34;,
</span></span><span style="display:flex;"><span>    &#34;gender&#34; =&gt; &#34;1&#34;
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$this-&gt;delete(&#34;user&#34;, [
</span></span><span style="display:flex;"><span>    &#34;id&#34; =&gt; 2
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>if ($this-&gt;has(&#34;user&#34;, [&#34;id&#34; =&gt; 23]))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    $this-&gt;rollBack();
</span></span><span style="display:flex;"><span>} else {
</span></span><span style="display:flex;"><span>    $this-&gt;commit();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="823使用"><strong>8.2.3使用</strong> <a href="#823%e4%bd%bf%e7%94%a8" class="anchor">🔗</a></h4><p>项目中使用，数据库表结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">TABLE</span><span style="color:#bbb"> </span><span style="color:#666">`</span>user_info<span style="color:#666">`</span><span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">`</span>uid<span style="color:#666">`</span><span style="color:#bbb"> </span><span style="color:#0b0;font-weight:bold">int</span>(<span style="color:#666">11</span>)<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#800">NULL</span><span style="color:#bbb"> </span><span style="color:#a2f">AUTO_INCREMENT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#666">`</span>nick<span style="color:#666">`</span><span style="color:#bbb"> </span><span style="color:#0b0;font-weight:bold">varchar</span>(<span style="color:#666">15</span>)<span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#800">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#a2f;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(<span style="color:#666">`</span>uid<span style="color:#666">`</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>)<span style="color:#bbb"> </span><span style="color:#a2f">ENGINE</span><span style="color:#666">=</span>InnoDB<span style="color:#bbb"> </span><span style="color:#a2f">AUTO_INCREMENT</span><span style="color:#666">=</span><span style="color:#666">1000001</span><span style="color:#bbb"> </span><span style="color:#a2f;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#a2f">CHARSET</span><span style="color:#666">=</span>utf8;<span style="color:#bbb">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class MysqlDemo
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    public function getOne(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>        $res = $database-&gt;select(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34;,
</span></span><span style="display:flex;"><span>            &#34;nick&#34;,
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo getOne&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function save(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $username = $request-&gt;post[&#39;username&#39;];
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>        $last_user_id = $database-&gt;insert(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; time(),
</span></span><span style="display:flex;"><span>            &#34;nick&#34; =&gt; $username,
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo save&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;last_user_id&#39; =&gt; $last_user_id,
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $username,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function del(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $res = $database-&gt;delete(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo del&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    public function update(\Swoole\Http\Request $request, \Swoole\Http\Response $response)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $uid = $request-&gt;post[&#39;uid&#39;];
</span></span><span style="display:flex;"><span>        $username = $request-&gt;post[&#39;username&#39;];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $database = new \Simps\DB\BaseModel();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        $res = $database-&gt;update(&#34;user_info&#34;, [
</span></span><span style="display:flex;"><span>            &#34;nick&#34; =&gt; $username
</span></span><span style="display:flex;"><span>        ], [
</span></span><span style="display:flex;"><span>            &#34;uid&#34; =&gt; $uid
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        return [
</span></span><span style="display:flex;"><span>            &#34;code&#34; =&gt; 200,
</span></span><span style="display:flex;"><span>            &#34;msg&#34; =&gt; &#34;MysqlDemo update&#34;,
</span></span><span style="display:flex;"><span>            &#34;data&#34; =&gt; [
</span></span><span style="display:flex;"><span>                &#39;res&#39; =&gt; $res,
</span></span><span style="display:flex;"><span>                &#39;uid&#39; =&gt; $uid,
</span></span><span style="display:flex;"><span>                &#39;username&#39; =&gt; $username,
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="九addprocess"><strong>(九).addProcess</strong> <a href="#%e4%b9%9daddprocess" class="anchor">🔗</a></h1><p>添加一个用户自定义的工作进程。此函数通常用于创建一个特殊的工作进程，用于监控、上报或者其他特殊的任务。具体内容可参考Swoole官网<a href="https://wiki.swoole.com/#/server/methods?id=addprocess" target="_blank" rel="noopener"><strong>addProcess</strong></a></p>
<p><strong>注意事项：</strong></p>
<ul>
<li>创建的子进程可以调用 <code>$server</code> 对象提供的各个方法，如 <code>getClientList/getClientInfo/stats</code></li>
<li>在 <code>Worker/Task</code> 进程中可以调用 <code>$process</code> 提供的方法与子进程进行通信</li>
<li>在用户自定义进程中可以调用 <code>$server-&gt;sendMessage</code> 与 <code>Worker/Task</code> 进程通信</li>
<li>用户进程内不能使用 <code>Server-&gt;task/taskwait</code> 接口</li>
<li>用户进程内可以使用 <code>Server-&gt;send/close</code> 等接口</li>
<li>用户进程内应当进行 <code>while(true)</code>(如下边的示例) 或 <a href="https://wiki.swoole.com/#/learn?id=%e4%bb%80%e4%b9%88%e6%98%afeventloop" target="_blank" rel="noopener">EventLoop</a> 循环 (例如创建个定时器)，否则用户进程会不停地退出重启</li>
</ul>
<p><strong>使用示例</strong></p>
<p>添加一个用户自定义的工作进程，在<code>./config/conf.php</code>中增加<code>process</code>配置，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&#39;process&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\Process::class, &#39;addProcess&#39;]
</span></span><span style="display:flex;"><span>    ],
</span></span></code></pre></div><p>控制器示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>namespace App\Controller;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>class Process
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    //添加用户自定义的工作进程
</span></span><span style="display:flex;"><span>    public function addProcess($server)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        return new \Swoole\Process(function ($process) use ($server) {
</span></span><span style="display:flex;"><span>            while (true) {
</span></span><span style="display:flex;"><span>                \Co::sleep(1);
</span></span><span style="display:flex;"><span>                echo &#34;Hello, api-swoole!\r\n&#34;;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }, false, 2, 1);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="十订制事件注册"><strong>(十).订制事件注册</strong> <a href="#%e5%8d%81%e8%ae%a2%e5%88%b6%e4%ba%8b%e4%bb%b6%e6%b3%a8%e5%86%8c" class="anchor">🔗</a></h1><p>框架已默认埋点<code>workerStart、open、close、task、finish</code>五个订制事件注册。可根据具体的业务特征在对应的事件回调增加处理业务代码，<code>./confg/events.php</code>，每个事件允许有多个回调。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;?php
</span></span><span style="display:flex;"><span>return [
</span></span><span style="display:flex;"><span>    &#39;workerStart&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Ext\Pool::class, &#39;startPool&#39;],//启动连接池
</span></span><span style="display:flex;"><span>//        [\App\Controller\EventsDemo::class, &#39;workerStart&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;open&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;open&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;close&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;close&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;task&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;task&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    &#39;finish&#39; =&gt; [
</span></span><span style="display:flex;"><span>        [\App\Controller\EventsDemo::class, &#39;finish&#39;],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div>
    </div>

    
        <div class="tags">
            
                <a href="https://liutongke.github.io/tags/api">api</a>
            
                <a href="https://liutongke.github.io/tags/swoole">swoole</a>
            
                <a href="https://liutongke.github.io/tags/websocket">websocket</a>
            
                <a href="https://liutongke.github.io/tags/tcp">tcp</a>
            
                <a href="https://liutongke.github.io/tags/udp">udp</a>
            
                <a href="https://liutongke.github.io/tags/http">http</a>
            
                <a href="https://liutongke.github.io/tags/php">php</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/liutongke" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 72 72" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>Github</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Social-Icons---Rounded-Black" transform="translate(-264.000000, -939.000000)">
            <g id="Github" transform="translate(264.000000, 939.000000)">
                <path d="M8,72 L64,72 C68.418278,72 72,68.418278 72,64 L72,8 C72,3.581722 68.418278,-8.11624501e-16 64,0 L8,0 C3.581722,8.11624501e-16 -5.41083001e-16,3.581722 0,8 L0,64 C5.41083001e-16,68.418278 3.581722,72 8,72 Z" id="Rounded" fill="#bbbbbb"></path>
                <path d="M35.9985,13 C22.746,13 12,23.7870921 12,37.096644 C12,47.7406712 18.876,56.7718301 28.4145,59.9584121 C29.6145,60.1797862 30.0525,59.4358488 30.0525,58.7973276 C30.0525,58.2250681 30.0315,56.7100863 30.0195,54.6996482 C23.343,56.1558981 21.9345,51.4693938 21.9345,51.4693938 C20.844,48.6864054 19.2705,47.9454799 19.2705,47.9454799 C17.091,46.4500754 19.4355,46.4801943 19.4355,46.4801943 C21.843,46.6503662 23.1105,48.9634994 23.1105,48.9634994 C25.2525,52.6455377 28.728,51.5823398 30.096,50.9649018 C30.3135,49.4077535 30.9345,48.3460615 31.62,47.7436831 C26.2905,47.1352808 20.688,45.0691228 20.688,35.8361671 C20.688,33.2052792 21.6225,31.0547881 23.1585,29.3696344 C22.911,28.7597262 22.0875,26.3110578 23.3925,22.9934585 C23.3925,22.9934585 25.4085,22.3459017 29.9925,25.4632101 C31.908,24.9285993 33.96,24.6620468 36.0015,24.6515052 C38.04,24.6620468 40.0935,24.9285993 42.0105,25.4632101 C46.5915,22.3459017 48.603,22.9934585 48.603,22.9934585 C49.9125,26.3110578 49.089,28.7597262 48.8415,29.3696344 C50.3805,31.0547881 51.309,33.2052792 51.309,35.8361671 C51.309,45.0917119 45.6975,47.1292571 40.3515,47.7256117 C41.2125,48.4695491 41.9805,49.9393525 41.9805,52.1877301 C41.9805,55.4089489 41.9505,58.0067059 41.9505,58.7973276 C41.9505,59.4418726 42.3825,60.1918338 43.6005,59.9554002 C53.13,56.7627944 60,47.7376593 60,37.096644 C60,23.7870921 49.254,13 35.9985,13" fill="#FFFFFF"></path>
            </g>
        </g>
    </g>
</svg>
    </a>


</div>

    

    <div class="copyright">
    
        Copyright © 2017-2022
    
    </div>

    
    
    <div class="busuanzi-footer">
  <span id="busuanzi_container_site_pv">
    总访问量<span id="busuanzi_value_site_pv"></span>次
  </span>
        <span id="busuanzi_container_site_uv">
    总访客数<span id="busuanzi_value_site_uv"></span>人次
  </span>
    </div>
    
</footer>



  </body>
</html>
